<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ALTA CAL PROFIT SHARE</title>

  <!-- Mobile PWA feel on iOS (optional) -->
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (production) + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* iOS friendliness */
    html { -webkit-text-size-adjust: 100%; }
    input, select, textarea, button { font-size: 16px; } /* prevent iOS zoom */
    * { -webkit-tap-highlight-color: transparent; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
    .paper { background: #fff; border-radius: .5rem; padding: 1rem; max-height: 90vh; overflow: auto; }
    .paper { -webkit-overflow-scrolling: touch; }

    /* Force header buttons to wrap on iPhone/iPad so nothing disappears */
    @media (max-width: 640px) {
      .header-buttons { flex-wrap: wrap !important; gap: 6px !important; justify-content: flex-start !important; }
      .header-buttons button { flex: 1 1 100%; min-width: 160px; }
      .title-mobile { margin-bottom: .5rem; }
    }

    /* PRINT: isolate current overlay (individual or report) */
    @media print {
      @page { size: letter portrait; margin: 0.5in; }
      body * { visibility: hidden !important; }
      .print-area, .print-area * { visibility: visible !important; }
      .print-area { position: static !important; background: #fff !important; }

      .paper { width: 7.75in !important; max-height: unset !important; overflow: visible !important;
               padding: 0 !important; border: none !important; border-radius: 0 !important; }

      /* Typography for readability */
      .print-lg   { font-size: 22px !important; }
      .print-md   { font-size: 16px !important; }
      .print-sm   { font-size: 13px !important; }
      .print-chip { font-size: 14px !important; padding: 6px 8px !important; }

      .print-section { page-break-inside: avoid; }
      .report-page   { page-break-after: always; }
      .report-table th, .report-table td { font-size: 12px !important; padding: 6px 8px !important; }
    }

    /* iOS Safari sometimes ignores @page; fallback margins */
    @supports (-webkit-touch-callout: none) {
      @media print {
        @page { size: auto; margin: 12mm; }
        .paper { width: auto !important; margin: 0 !important; }
      }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    /* ================= Helpers ================= */
    const fmt = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format((+n)||0);
    const num = s => { const x=parseFloat(String(s??'').replace(/[,$]/g,'')); return Number.isFinite(x)?x:0; };
    const pctFee = (amount, feePct) => (num(amount) * (num(feePct)/100));
    const onlyNum = s => (s||'').replace(/[^0-9.]/g,'');
    const onlyInt = s => (s||'').replace(/[^0-9]/g,'');
    const fit = (arr, count) => {
      const c = Math.max(0, parseInt(count||0,10)||0);
      const base = Array.isArray(arr) ? [...arr] : [];
      if (base.length > c) return base.slice(0,c);
      while (base.length < c) base.push('');
      return base;
    };

    const defaultHousePct = (contractAmount) => {
      const a = num(contractAmount);
      if (a <= 20000) return 10;
      if (a < 30000)  return 9;
      return 8; // >= 30000
    };

    function calcOne(d){
      const effectiveHousePct = d.houseFeeManual
        ? num(d.houseFeePercent)
        : (d.houseFeePercent ? num(d.houseFeePercent) : defaultHousePct(d.contractAmount));

      const contract     = num(d.contractAmount);
      const housePct     = effectiveHousePct;
      const houseFee     = (contract * housePct)/100;

      const dealerFeeAmt = pctFee(d.financeAmount, d.dealerFee);
      const ccFeeAmt     = pctFee(d.creditCard, d.creditCardFee);

      const afterHouse   = contract - houseFee;
      const afterFees    = afterHouse - num(d.laborMaterial) - dealerFeeAmt;
      const marginPct    = afterHouse>0 ? (afterFees/afterHouse)*100 : 0;

      let vetRate=25, repRate=20;
      if (marginPct >= 50) { vetRate=55; repRate=40; }
      else if (marginPct >= 40) { vetRate=45; repRate=30; }
      else if (marginPct >= 33) { vetRate=35; repRate=25; }

      const vets = num(d.numVets), reps = num(d.numReps);
      const people = vets + reps;

      const vetPool = afterFees * (vetRate/100);
      const repPool = afterFees * (repRate/100);
      const perVet  = people>0 ? vetPool/people : 0;
      const perRep  = people>0 ? repPool/people : 0;

      const rideAlongFee     = num(d.rideAlong);
      const rideAlongBonus   = num(d.rideAlongBonus);
      const rideAlongTotal   = rideAlongFee + rideAlongBonus;
      const rideAlongPer     = (people>0) ? rideAlongFee/people : 0;
      const ccPer            = (people>0) ? ccFeeAmt/people : 0;

      const netPerVet = perVet - rideAlongPer - ccPer;
      const netPerRep = perRep - rideAlongPer - ccPer;

      const totalVets = netPerVet * vets;
      const totalReps = netPerRep * reps;

      const rasCount  = num(d.numRideAlongs);
      const perRA     = rasCount>0 ? (rideAlongTotal/rasCount) : 0;

      const combined  = totalVets + totalReps;

      return {
        contract, housePct, houseFee,
        dealerFeeAmt, ccFeeAmt, labor:num(d.laborMaterial),
        finance:num(d.financeAmount), dealerPct:num(d.dealerFee), ccPct:num(d.creditCardFee),
        afterFees, marginPct, vetRate, repRate,
        perVet: netPerVet, perRep: netPerRep,
        totalVets, totalReps, combined,
        rideAlongTotal, perRA
      };
    }

    /* ================= Icons ================= */
    const Icon = ({children,size=20}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        {children}
      </svg>
    );
    const Printer = ({size=20}) => (
      <Icon size={size}>
        <polyline points="6 9 6 2 18 2 18 9"></polyline>
        <path d="M6 18H4a 2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
        <rect x="6" y="14" width="12" height="8"></rect>
      </Icon>
    );
    const Plus = ({size=20}) => (
      <Icon size={size}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>
    );
    const X = ({size=20}) => (
      <Icon size={size}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>
    );

    /* ================= App ================= */
    function App(){
      const blank = () => ({
        id: Date.now(),
        customerName:'', jobNumber:'',
        contractAmount:'', cashCheck:'',
        financeAmount:'', dealerFee:'',
        creditCard:'', creditCardFee:'',
        houseFeePercent:'', houseFeeManual:false,
        laborMaterial:'',
        rideAlong:'', rideAlongBonus:'',
        numVets:'', numReps:'', numRideAlongs:'',
        vetNames:[], repNames:[], rideAlongNames:[]
      });

      const [rows, setRows] = React.useState([ blank() ]);
      const [printIndex, setPrintIndex] = React.useState(null);
      const [showReport, setShowReport] = React.useState(false);

      /* Ensure House % auto when not manual */
      React.useEffect(()=>{
        setRows(prev=>{
          let changed=false;
          const next=prev.map(r=>{
            if(!r.houseFeeManual){
              const want=String(defaultHousePct(r.contractAmount));
              if(!r.houseFeePercent || r.houseFeePercent!==want){
                changed=true; return {...r, houseFeePercent: want};
              }
            }
            return r;
          });
          return changed?next:prev;
        });
      }, [rows.length]);

      const upd = (idx, key, val) => {
        setRows(r=>{
          const a=[...r]; const row={...a[idx]};
          if (key==='contractAmount'){
            row.contractAmount = onlyNum(val);
            if(!row.houseFeeManual){
              row.houseFeePercent = String(defaultHousePct(row.contractAmount));
            }
          } else if (key==='houseFeePercent'){
            row.houseFeePercent = onlyNum(val);
            row.houseFeeManual = true;
          } else if (key==='numVets'){
            row.numVets = onlyInt(val);
            row.vetNames = fit(row.vetNames, row.numVets);
          } else if (key==='numReps'){
            row.numReps = onlyInt(val);
            row.repNames = fit(row.repNames, row.numReps);
          } else if (key==='numRideAlongs'){
            row.numRideAlongs = onlyInt(val);
            row.rideAlongNames = fit(row.rideAlongNames, row.numRideAlongs);
          } else {
            row[key]=val;
          }
          a[idx]=row; return a;
        });
      };

      const updName = (idx, kind, i, val) => {
        setRows(r=>{
          const a=[...r], row={...a[idx]};
          const key = kind+'Names';
          const count = kind==='vet' ? row.numVets : kind==='rep' ? row.numReps : row.numRideAlongs;
          row[key] = fit(row[key], count);
          row[key][i] = val;
          a[idx]=row; return a;
        });
      };

      return (
        <div className="max-w-6xl mx-auto p-4">
          <div className="bg-white border-4 border-blue-500 rounded-lg p-4 mb-4">
            <div className="flex items-center justify-between flex-wrap">
              <h1 className="text-2xl font-bold text-blue-800 title-mobile">ALTA CAL PROFIT SHARE</h1>
              <div className="flex gap-2 header-buttons">
                <button className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2"
                        onClick={()=>setShowReport(true)}>
                  <Printer/> Print Report
                </button>
                <button className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2"
                        onClick={()=>setRows(r=>[...r, blank()])}>
                  <Plus/> Add File
                </button>
              </div>
            </div>
          </div>

          {rows.map((row, idx)=>{
            const c = calcOne(row);
            return (
              <div key={row.id} className="bg-white border-4 border-gray-300 rounded-lg mb-6">
                <div className="bg-blue-300 border-b-2 border-black px-4 py-2 flex justify-between items-center">
                  <strong>CALCULATOR #{idx+1}</strong>
                  <button className="bg-blue-600 text-white px-3 py-1 rounded flex items-center gap-1"
                          onClick={()=>setPrintIndex(idx)}>
                    <Printer/> Print
                  </button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 border-b-2 border-black">
                  <Labeled label="CUSTOMER NAME" value={row.customerName} onChange={v=>upd(idx,'customerName',v)}/>
                  <Labeled label="JOB NUMBER"    value={row.jobNumber}    onChange={v=>upd(idx,'jobNumber',v)}/>
                </div>

                <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                  <Money   label="CONTRACT AMOUNT" value={row.contractAmount}
                           onChange={v=>upd(idx,'contractAmount',v)} onBlur={()=>upd(idx,'contractAmount',row.contractAmount)}/>
                  <Money   label="CASH/CHECK"      value={row.cashCheck} onChange={v=>upd(idx,'cashCheck',onlyNum(v))}/>
                  <Money   label="LABOR & MATERIAL" value={row.laborMaterial} onChange={v=>upd(idx,'laborMaterial',onlyNum(v))}/>
                </div>

                <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="border-2 rounded p-3">
                    <Money label="FINANCE AMOUNT" value={row.financeAmount} onChange={v=>upd(idx,'financeAmount',onlyNum(v))}/>
                    <Pct   label="DEALER FEE (%)" value={row.dealerFee}   onChange={v=>upd(idx,'dealerFee',onlyNum(v))}/>
                    <div className="text-sm text-center font-bold mt-1">{fmt(c.dealerFeeAmt)}</div>
                  </div>
                  <div className="border-2 rounded p-3">
                    <Money label="CREDIT CARD" value={row.creditCard} onChange={v=>upd(idx,'creditCard',onlyNum(v))}/>
                    <Pct   label="CC FEE (%)"  value={row.creditCardFee} onChange={v=>upd(idx,'creditCardFee',onlyNum(v))}/>
                    <div className="text-sm text-center font-bold mt-1">{fmt(c.ccFeeAmt)}</div>
                  </div>
                </div>

                <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="border-2 rounded p-3">
                    <Pct label="HOUSE FEE (%)" value={row.houseFeePercent}
                         onChange={v=>upd(idx,'houseFeePercent',v)}/>
                    <div className="text-center text-lg font-bold mt-1">House: {fmt(c.houseFee)}</div>
                    <div className="text-xs text-center text-gray-600 mt-1">Auto: 10% ≤ $20k; 9% $20k–$30k; 8% ≥ $30k</div>
                  </div>
                  <div className="border-2 rounded p-3">
                    <Money label="RIDE ALONG FEE" value={row.rideAlong} onChange={v=>upd(idx,'rideAlong',onlyNum(v))}/>
                    <div className="text-center text-sm font-bold mt-1">
                      Per Person Split: {fmt((num(row.rideAlong)/(num(row.numVets)+num(row.numReps)||1)))}
                    </div>
                  </div>
                  <Money label="RIDE ALONG BONUS" value={row.rideAlongBonus} onChange={v=>upd(idx,'rideAlongBonus',onlyNum(v))}/>
                </div>

                <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                  <Stat title="TOTAL AFTER FEES" value={fmt(c.afterFees)}/>
                  <Stat title="VETS %" value={`${c.vetRate}%`}/>
                  <Stat title="REPS %" value={`${c.repRate}%`}/>
                </div>

                <div className="p-4 space-y-6">
                  <Group label="VETS ON CONTRACT" count={row.numVets} setCount={v=>upd(idx,'numVets',v)}
                         names={fit(row.vetNames,row.numVets)} per={c.perVet} color="green"
                         setName={(i,val)=>updName(idx,'vet',i,val)} />
                  <Group label="REPS ON CONTRACT" count={row.numReps} setCount={v=>upd(idx,'numReps',v)}
                         names={fit(row.repNames,row.numReps)} per={c.perRep} color="purple"
                         setName={(i,val)=>updName(idx,'rep',i,val)} />
                  <Group label="RIDE ALONGS" count={row.numRideAlongs} setCount={v=>upd(idx,'numRideAlongs',v)}
                         names={fit(row.rideAlongNames,row.numRideAlongs)} per={c.perRA} color="red"
                         setName={(i,val)=>updName(idx,'rideAlong',i,val)} />
                </div>
              </div>
            );
          })}

          {printIndex!==null && <PrintOne row={rows[printIndex]} index={printIndex} onClose={()=>setPrintIndex(null)}/>}

          {showReport && <ReportOverlay rows={rows} onClose={()=>setShowReport(false)}/>}
        </div>
      );
    }

    /* ===== UI bits ===== */
    const Labeled = ({label,value,onChange}) => (
      <div>
        <label className="text-xs font-bold block mb-1">{label}</label>
        <input className="w-full border-2 rounded px-2 py-2" value={value||''} onChange={e=>onChange(e.target.value)}/>
      </div>
    );
    const Money = ({label,value,onChange,onBlur}) => (
      <div>
        <label className="text-xs font-bold block mb-1">{label}</label>
        <div className="flex items-center border-2 rounded px-2 py-2"><span className="mr-1">$</span>
          <input className="w-full text-right outline-none" value={value||''}
                 onChange={e=>onChange(e.target.value)} onBlur={onBlur} inputMode="decimal"/>
        </div>
      </div>
    );
    const Pct = ({label,value,onChange}) => (
      <div>
        <label className="text-xs font-bold block mb-1">{label}</label>
        <div className="flex items-center border-2 rounded px-2 py-2">
          <input className="w-full text-right outline-none" value={value||''}
                 onChange={e=>onChange(e.target.value)} inputMode="decimal"/>
          <span className="ml-1">%</span>
        </div>
      </div>
    );
    const Stat = ({title,value}) => (
      <div className="border-2 rounded p-3 text-center">
        <div className="text-xs font-bold mb-1">{title}</div>
        <div className="text-xl font-bold">{value}</div>
      </div>
    );

    function Group({label, count, setCount, names, per, color, setName}){
      return (
        <div className="space-y-2">
          <div>
            <label className="text-xs font-bold block mb-1">{label}</label>
            <input className="w-32 text-center text-lg border-2 rounded px-2 py-2"
              value={count||''} onChange={e=>setCount((e.target.value||'').replace(/[^0-9]/g,''))} inputMode="numeric"/>
          </div>
          {num(count)>0 && (
            <ListWithAmounts
              label={label} names={names} perAmount={per} color={color}
              onNameChange={setName}
            />
          )}
        </div>
      );
    }

    function ListWithAmounts({label, names, perAmount, color='gray', onNameChange}){
      const colorMap = {
        green:  'border-green-600 text-green-700',
        purple: 'border-purple-600 text-purple-700',
        red:    'border-red-600 text-red-700',
        gray:   'border-gray-600 text-gray-700'
      };
      const c = colorMap[color] || colorMap.gray;
      return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          {names.map((n,i)=>(
            <div key={i} className={`flex items-center justify-between border rounded px-3 py-2 bg-white ${c}`}>
              <div className="flex-1 mr-2">
                <input className="w-full outline-none"
                       placeholder={`${label} ${i+1} Name`}
                       value={n||''}
                       onChange={e=>onNameChange(i,e.target.value)}/>
              </div>
              <div className="font-extrabold">{fmt(perAmount)}</div>
            </div>
          ))}
        </div>
      );
    }

    /* ====== PRINT: Individual calculator only (no profit) ====== */
    function PrintOne({row, index, onClose}){
      const c   = calcOne(row);
      const vets= fit(row.vetNames, row.numVets);
      const reps= fit(row.repNames, row.numReps);
      const ras = fit(row.rideAlongNames, row.numRideAlongs);

      return (
        <div className="overlay print-area">
          <div className="paper w-full max-w-[7.9in]">
            <div className="print-section">
              <h2 className="font-bold text-center mb-3 print-lg">ALTA CAL — CALCULATOR #{index+1}</h2>

              <div className="mb-3 grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded border">
                <div><span className="font-semibold">Customer:</span> <span className="font-semibold">{row.customerName || 'N/A'}</span></div>
                <div><span className="font-semibold">Job#:</span> <span className="font-semibold">{row.jobNumber || 'N/A'}</span></div>
              </div>

              <div className="mb-4 bg-blue-50 border-2 border-blue-400 rounded p-3">
                <h3 className="font-bold mb-2 print-md">CONTRACT & FEE BREAKDOWN</h3>
                <div className="grid grid-cols-2 gap-2 print-sm">
                  <div><strong>Contract:</strong> {fmt(c.contract)}</div>
                  <div><strong>House Fee %:</strong> {c.housePct || 0}% &nbsp; (<strong>Amt:</strong> {fmt(c.houseFee)})</div>
                  <div><strong>Finance Amount:</strong> {fmt(c.finance)}</div>
                  <div><strong>Dealer Fee %:</strong> {c.dealerPct || 0}% &nbsp; (<strong>Amt:</strong> {fmt(c.dealerFeeAmt)})</div>
                  <div><strong>Credit Card:</strong> {fmt(num(row.creditCard))}</div>
                  <div><strong>CC Fee %:</strong> {c.ccPct || 0}% &nbsp; (<strong>Amt:</strong> {fmt(c.ccFeeAmt)})</div>
                  <div><strong>Labor & Material:</strong> {fmt(c.labor)}</div>
                  <div className="font-semibold text-right"><strong>Total After Fees:</strong> {fmt(c.afterFees)}</div>
                </div>
              </div>

              <div className="mb-4 grid grid-cols-3 gap-3">
                <div className="border rounded p-2 text-center">
                  <div className="text-xs font-bold">VETS %</div>
                  <div className="print-chip font-semibold">{c.vetRate}%</div>
                </div>
                <div className="border rounded p-2 text-center">
                  <div className="text-xs font-bold">REPS %</div>
                  <div className="print-chip font-semibold">{c.repRate}%</div>
                </div>
                <div className="border rounded p-2 text-center">
                  <div className="text-xs font-bold">MARGIN %</div>
                  <div className="print-chip font-semibold">{(c.marginPct||0).toFixed(1)}%</div>
                </div>
              </div>

              {num(row.numVets)>0 && (
                <div className="mb-3 print-sm">
                  <div className="font-bold mb-1">Vets (Per: {fmt(c.perVet)})</div>
                  {vets.map((n,i)=>(
                    <div key={i} className="flex justify-between border-b py-1">
                      <span>{n || `Vet ${i+1}`}</span><span className="font-semibold">{fmt(c.perVet)}</span>
                    </div>
                  ))}
                  <div className="text-right mt-1"><strong>Total Vets:</strong> {fmt(c.totalVets)}</div>
                </div>
              )}

              {num(row.numReps)>0 && (
                <div className="mb-3 print-sm">
                  <div className="font-bold mb-1">Reps (Per: {fmt(c.perRep)})</div>
                  {reps.map((n,i)=>(
                    <div key={i} className="flex justify-between border-b py-1">
                      <span>{n || `Rep ${i+1}`}</span><span className="font-semibold">{fmt(c.perRep)}</span>
                    </div>
                  ))}
                  <div className="text-right mt-1"><strong>Total Reps:</strong> {fmt(c.totalReps)}</div>
                </div>
              )}

              {num(row.numRideAlongs)>0 && (
                <div className="mb-3 print-sm">
                  <div className="font-bold mb-1">Ride Alongs (Per: {fmt(c.perRA)})</div>
                  {fit(row.rideAlongNames,row.numRideAlongs).map((n,i)=>(
                    <div key={i} className="flex justify-between border-b py-1">
                      <span>{n || `Ride Along ${i+1}`}</span><span className="font-semibold">{fmt(c.perRA)}</span>
                    </div>
                  ))}
                  <div className="text-right mt-1"><strong>Total RA Payout:</strong> {fmt(c.rideAlongTotal)}</div>
                </div>
              )}

              <div className="mt-3 grid grid-cols-2 gap-3">
                <div className="bg-green-50 border border-green-400 rounded p-3 text-center">
                  <div className="text-xs font-bold">COMBINED PAYOUT</div>
                  <div className="font-semibold text-lg">{fmt(c.combined)}</div>
                </div>
                <div className="bg-blue-50 border border-blue-400 rounded p-3 text-center">
                  <div className="text-xs font-bold">TOTAL AFTER FEES</div>
                  <div className="font-semibold text-lg">{fmt(c.afterFees)}</div>
                </div>
              </div>
            </div>

            <div className="no-print flex justify-center gap-2 mt-4">
              <button className="bg-blue-600 text-white px-4 py-2 rounded" onClick={()=>window.print()}>PRINT</button>
              <button className="bg-gray-600 text-white px-4 py-2 rounded" onClick={onClose}>CLOSE</button>
            </div>
          </div>
        </div>
      );
    }

    /* ====== REPORT: combined sheet with per-person totals (no profit) ====== */
    function ReportOverlay({rows, onClose}){
      // aggregate per-person totals across all files
      const add = (map, name, amount) => {
        const key = (name||'').trim() || '(Unnamed)';
        map.set(key, (map.get(key)||0) + (amount||0));
      };

      const grand = { vets:new Map(), reps:new Map(), ras:new Map() };

      const tableRows = rows.map((r, i) => {
        const c = calcOne(r);
        const vets = fit(r.vetNames, r.numVets);
        const reps = fit(r.repNames, r.numReps);
        const ras  = fit(r.rideAlongNames, r.numRideAlongs);

        // accumulate
        vets.forEach(n => add(grand.vets, n, c.perVet));
        reps.forEach(n => add(grand.reps, n, c.perRep));
        ras .forEach(n => add(grand.ras , n, c.perRA));

        return { i, r, c, vets, reps, ras };
      });

      const totVet   = [...grand.vets.values()].reduce((a,b)=>a+b,0);
      const totRep   = [...grand.reps.values()].reduce((a,b)=>a+b,0);
      const totRA    = [...grand.ras.values()].reduce((a,b)=>a+b,0);
      const totComb  = totVet + totRep;

      return (
        <div className="overlay print-area">
          <div className="paper w-full max-w-[8.1in]">
            <div className="report-page">
              <h2 className="font-bold text-center mb-3 print-lg">ALTA CAL — PAYOUT REPORT</h2>

              <table className="w-full border-2 border-black report-table">
                <thead>
                  <tr className="bg-blue-200 border-b-2 border-black">
                    <th className="border border-black text-left">#</th>
                    <th className="border border-black text-left">Customer</th>
                    <th className="border border-black text-left">Job#</th>
                    <th className="border border-black text-right">Vets</th>
                    <th className="border border-black text-right">Per Vet</th>
                    <th className="border border-black text-right">Total Vet</th>
                    <th className="border border-black text-right">Reps</th>
                    <th className="border border-black text-right">Per Rep</th>
                    <th className="border border-black text-right">Total Rep</th>
                    <th className="border border-black text-right">RAs</th>
                    <th className="border border-black text-right">Per RA</th>
                    <th className="border border-black text-right">Total RA</th>
                    <th className="border border-black text-right bg-green-200">Combined</th>
                    <th className="border border-black text-right bg-blue-100">After Fees</th>
                  </tr>
                </thead>
                <tbody>
                  {tableRows.map(({i,r,c})=>(
                    <tr key={i} className="border-b border-gray-400">
                      <td className="border border-black p-1">{i+1}</td>
                      <td className="border border-black p-1">{r.customerName || 'N/A'}</td>
                      <td className="border border-black p-1">{r.jobNumber || 'N/A'}</td>
                      <td className="border border-black p-1 text-right">{num(r.numVets)||''}</td>
                      <td className="border border-black p-1 text-right">{num(r.numVets)?fmt(c.perVet):''}</td>
                      <td className="border border-black p-1 text-right bg-green-50 font-bold">{num(r.numVets)?fmt(c.totalVets):''}</td>
                      <td className="border border-black p-1 text-right">{num(r.numReps)||''}</td>
                      <td className="border border-black p-1 text-right">{num(r.numReps)?fmt(c.perRep):''}</td>
                      <td className="border border-black p-1 text-right bg-purple-50 font-bold">{num(r.numReps)?fmt(c.totalReps):''}</td>
                      <td className="border border-black p-1 text-right">{num(r.numRideAlongs)||''}</td>
                      <td className="border border-black p-1 text-right">{num(r.numRideAlongs)?fmt(c.perRA):''}</td>
                      <td className="border border-black p-1 text-right bg-red-50 font-bold">{num(r.numRideAlongs)?fmt(c.rideAlongTotal):''}</td>
                      <td className="border border-black p-1 text-right bg-green-200 font-bold">{fmt(c.combined)}</td>
                      <td className="border border-black p-1 text-right bg-blue-100 font-bold">{fmt(c.afterFees)}</td>
                    </tr>
                  ))}

                  <tr className="bg-yellow-100 font-bold border-t-4 border-black">
                    <td colSpan="5" className="border border-black p-1 text-right">TOTALS:</td>
                    <td className="border border-black p-1 text-right bg-green-100">{fmt(totVet)}</td>
                    <td colSpan="2" className="border border-black p-1"></td>
                    <td className="border border-black p-1 text-right bg-purple-100">{fmt(totRep)}</td>
                    <td colSpan="2" className="border border-black p-1"></td>
                    <td className="border border-black p-1 text-right bg-red-100">{fmt(totRA)}</td>
                    <td className="border border-black p-1 text-right bg-green-300">{fmt(totComb)}</td>
                    <td className="border border-black p-1 text-right bg-blue-200"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div className="report-page">
              <h3 className="font-bold mb-2 print-md">Grand Totals by Person</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <TotalsByPerson title="Vets" map={grand.vets} color="green"/>
                <TotalsByPerson title="Reps" map={grand.reps} color="purple"/>
                <TotalsByPerson title="Ride Alongs" map={grand.ras} color="red"/>
              </div>
            </div>

            <div className="no-print flex justify-center gap-2 mt-4">
              <button className="bg-blue-600 text-white px-4 py-2 rounded" onClick={()=>window.print()}>PRINT REPORT</button>
              <button className="bg-gray-600 text-white px-4 py-2 rounded" onClick={onClose}>CLOSE</button>
            </div>
          </div>
        </div>
      );
    }

    function TotalsByPerson({title, map, color}){
      const colorCls = {
        green:'border-green-600', purple:'border-purple-600', red:'border-red-600'
      }[color] || 'border-gray-600';
      const list = [...map.entries()].sort((a,b)=>b[1]-a[1]);
      return (
        <div className={`border-2 ${colorCls} rounded p-3`}>
          <div className="font-bold mb-2">{title}</div>
          {list.length===0 ? <div className="text-gray-500">None</div> : (
            <div className="space-y-1">
              {list.map(([name,amt],i)=>(
                <div key={i} className="flex justify-between border-b py-1">
                  <span>{name}</span><span className="font-semibold">{fmt(amt)}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    /* Mount */
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
