<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ALTA CAL PROFIT SHARE</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React UMD (prod) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (compile JSX on static hosting/GitHub Pages) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html{-webkit-text-size-adjust:100%}
    input,button{font-size:16px} /* iOS zoom fix */
    @media print{
      @page{ size: legal; margin: 0.5in }
      body{ print-color-adjust: exact; -webkit-print-color-adjust: exact }
      .no-print{ display:none !important }
    }
    /* Visible banner if something breaks (prevents "blank page") */
    #err{display:none;position:fixed;left:0;right:0;bottom:0;z-index:9999;background:#fee2e2;color:#991b1b;border-top:3px solid #ef4444;padding:8px 12px;font:600 13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .pill{border:2px solid #7c3aed;border-radius:12px;padding:10px 12px;display:flex;justify-content:space-between;gap:12px;background:#fff}
    .pill .amt{color:#7c3aed;font-weight:800}
    .pill.ra{border-color:#ef4444}.pill.ra .amt{color:#ef4444}
    .role-title{font-weight:900;text-transform:uppercase;display:flex;gap:8px;align-items:center}
  </style>
</head>
<body class="bg-gray-100">
  <div id="root" class="p-3 text-sm text-gray-600">Loadingâ€¦</div>
  <div id="err"></div>

  <script type="text/babel" data-presets="env,react">
    /* ===== never-silent errors ===== */
    const showErr = (m)=>{const e=document.getElementById('err');e.textContent='App error: '+m; e.style.display='block';};
    window.addEventListener('error',e=>showErr(e.message||'Unknown error'));
    window.addEventListener('unhandledrejection',e=>showErr((e.reason&&e.reason.message)||'Unhandled promise'));

    const {useState,useMemo} = React;

    /* ===== helpers ===== */
    const onlyNum = s => String(s||'').replace(/[^0-9.]/g,'');
    const onlyInt = s => String(s||'').replace(/[^0-9]/g,'');
    const num = v => { const x=parseFloat(String(v??'').replace(/[,$]/g,'')); return Number.isFinite(x)?x:0; };
    const fmt = v => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Number(v)||0);

    const defaultHousePct = (contractAmount)=>{
      const a = num(contractAmount);
      if (a <= 20000) return 10;
      if (a <= 30000) return 9;
      return 8;
    };

    const fit = (arr, count)=>{
      const c=Math.max(0, parseInt(count||0,10)||0);
      const base=Array.isArray(arr)?[...arr]:[];
      if (base.length>c) return base.slice(0,c);
      while(base.length<c) base.push('');
      return base;
    };

    function compute(row){
      const contract=num(row.contractAmount);
      const housePct = row.houseFeePercent ? num(row.houseFeePercent) : defaultHousePct(contract);
      const houseFee = contract * housePct/100;

      const finance=num(row.financeAmount);
      const dealerPct=num(row.dealerFee);
      const dealerFeeAmt=finance*dealerPct/100;

      const credit=num(row.creditCard);
      const ccPct=num(row.creditCardFee);
      const ccFeeAmt=credit*ccPct/100;

      const labor=num(row.laborMaterial);

      const afterHouse=contract-houseFee;
      const afterFees = afterHouse - labor - dealerFeeAmt;

      // tiers by margin %
      const margin = afterHouse>0 ? (afterFees/afterHouse)*100 : 0;
      let vetPct=25, repPct=20;
      if (margin>=50){ vetPct=55; repPct=40; }
      else if (margin>=40){ vetPct=45; repPct=30; }
      else if (margin>=33){ vetPct=35; repPct=25; }

      const vets=num(row.numVets), reps=num(row.numReps);
      const people=vets+reps || 0;
      const vetPool=afterFees*vetPct/100;
      const repPool=afterFees*repPct/100;

      const perVetBase=people?(vetPool/people):0;
      const perRepBase=people?(repPool/people):0;

      const rideAlongFee=num(row.rideAlong);
      const rideAlongBonus=num(row.rideAlongBonus);
      const rideAlongTotal=rideAlongFee+rideAlongBonus;

      const rideAlongPerPerson = people ? (rideAlongFee/people) : 0;
      const ccPerPerson        = people ? (ccFeeAmt/people) : 0;

      const perVet = perVetBase - rideAlongPerPerson - ccPerPerson;
      const perRep = perRepBase - rideAlongPerPerson - ccPerPerson;
      const perRA  = num(row.numRideAlongs) ? (rideAlongTotal/num(row.numRideAlongs)) : 0;

      return {
        contract, finance, credit, labor,
        housePct, houseFee, dealerPct, dealerFeeAmt, ccPct, ccFeeAmt,
        afterFees, afterHouse, margin, vetPct, repPct, perVet, perRep, perRA, rideAlongTotal
      };
    }

    /* ===== print (clean page, no hidden content) ===== */
    function openPrint(html,title){
      const w = window.open('', '_blank');
      if(!w){ alert('Pop-up blocked. Allow pop-ups to print.'); return; }
      w.document.open();
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>
<style>
@page{size:legal;margin:0.5in}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;print-color-adjust:exact;-webkit-print-color-adjust:exact}
h1{font-size:22px;margin:0 0 10px;text-align:center;border-bottom:3px solid #000;padding-bottom:6px}
h2{font-size:15px;margin:12px 0 6px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #000;padding:6px 8px;font-size:14px}
.right{text-align:right}
.top-pad{margin-top:12mm}
.page{page-break-after:always}
</style></head><body>${html}</body></html>`);
      w.document.close();
      setTimeout(()=>{ try{w.focus(); w.print();}catch(e){} }, 80);
    }

    function singlePrintHTML(row, idx){
      const c=compute(row);
      const vets=fit(row.vetNames,row.numVets);
      const reps=fit(row.repNames,row.numReps);
      const ras =fit(row.rideAlongNames,row.numRideAlongs);

      const block=(title,per,list)=> list.length ? `
        <h2>${title} (Per: ${fmt(per)})</h2>
        <table><thead><tr><th>Name</th><th>Payout</th></tr></thead>
        <tbody>${list.map(n=>`<tr><td>${(n||'').toString().trim()}</td><td class="right">${fmt(per)}</td></tr>`).join('')}</tbody></table>
      ` : '';

      return `
        <div class="page top-pad">
          <table style="margin-bottom:8px">
            <tbody>
              <tr><th>Customer</th><td>${(row.customerName||'').toString().trim()||'N/A'}</td></tr>
              <tr><th>Job#</th><td>${(row.jobNumber||'').toString().trim()||'N/A'}</td></tr>
            </tbody>
          </table>

          <h2>CONTRACT & FEE BREAKDOWN</h2>
          <table style="margin-bottom:10px">
            <tbody>
              <tr><th>Contract</th><td>${fmt(c.contract)}</td></tr>
              <tr><th>Finance Amount</th><td>${fmt(c.finance)}</td></tr>
              <tr><th>Credit Card</th><td>${fmt(c.credit)}</td></tr>
              <tr><th>Labor & Material</th><td>${fmt(c.labor)}</td></tr>
              <tr><th>House Fee %</th><td>${c.housePct}% (Amt: ${fmt(c.houseFee)})</td></tr>
              <tr><th>Dealer Fee %</th><td>${c.dealerPct}% (Amt: ${fmt(c.dealerFeeAmt)})</td></tr>
              <tr><th>CC Fee %</th><td>${c.ccPct}% (Amt: ${fmt(c.ccFeeAmt)})</td></tr>
              <tr><th>Total After Fees</th><td>${fmt(c.afterFees)}</td></tr>
            </tbody>
          </table>

          <table style="margin-bottom:12px">
            <thead><tr><th>VETS %</th><th>REPS %</th><th>MARGIN %</th></tr></thead>
            <tbody><tr><td>${c.vetPct}%</td><td>${c.repPct}%</td><td>${c.afterHouse>0?((c.afterFees/c.afterHouse)*100).toFixed(1):'0.0'}%</td></tr></tbody>
          </table>

          ${block('VETS', c.perVet, vets)}
          ${block('REPS', c.perRep, reps)}
          ${block('RIDE ALONGS', c.perRA, ras)}
        </div>
      `;
    }

    function reportPrintHTML(rows){
      const fileRows = rows.map((row,i)=>{
        const c=compute(row);
        const v=num(row.numVets), r=num(row.numReps), ra=num(row.numRideAlongs);
        return `<tr>
          <td>${i+1}</td>
          <td>${(row.customerName||'').toString().trim()||'N/A'}</td>
          <td>${(row.jobNumber||'').toString().trim()||'N/A'}</td>
          <td class="right">${v||''}</td>
          <td class="right">${v?fmt(c.perVet):''}</td>
          <td class="right">${v?fmt(c.perVet*v):''}</td>
          <td class="right">${r||''}</td>
          <td class="right">${r?fmt(c.perRep):''}</td>
          <td class="right">${r?fmt(c.perRep*r):''}</td>
          <td class="right">${ra||''}</td>
          <td class="right">${ra?fmt(c.perRA):''}</td>
          <td class="right">${ra?fmt(c.perRA*ra):''}</td>
        </tr>`;
      }).join('');

      // Totals by person across all files
      const totals={};
      const add=(name,amt)=>{const k=(name||'').toString().trim()||'(Unnamed)'; totals[k]=(totals[k]||0)+(amt||0);};
      rows.forEach(row=>{
        const c=compute(row);
        fit(row.vetNames,row.numVets).forEach(n=>add(n,c.perVet));
        fit(row.repNames,row.numReps).forEach(n=>add(n,c.perRep));
        fit(row.rideAlongNames,row.numRideAlongs).forEach(n=>add(n,c.perRA));
      });
      const peopleRows = Object.entries(totals)
        .sort((a,b)=>a[0].localeCompare(b[0]))
        .map(([nm,amt])=>`<tr><td>${nm}</td><td class="right">${fmt(amt)}</td></tr>`)
        .join('') || '<tr><td colspan="2">(No names)</td></tr>';

      return `
        <div class="page">
          <h1>ALTA CAL PROFIT SHARE â€” PAYOUT REPORT</h1>
          <table>
            <thead><tr>
              <th>#</th><th>Customer</th><th>Job#</th>
              <th>Vets</th><th>Per Vet</th><th>Total Vets</th>
              <th>Reps</th><th>Per Rep</th><th>Total Reps</th>
              <th>RAs</th><th>Per RA</th><th>Total RA</th>
            </tr></thead>
            <tbody>${fileRows}</tbody>
          </table>

          <h2 style="margin-top:14px">TOTAL BY PERSON (ALL FILES)</h2>
          <table><thead><tr><th>Person</th><th>Amount</th></tr></thead>
            <tbody>${peopleRows}</tbody></table>
        </div>
      `;
    }

    /* ===== small UI atoms ===== */
    const Label = ({children}) => <label className="text-xs font-bold block mb-1 uppercase">{children}</label>;
    const Text = (p) => <input {...p} className={"w-full px-2 py-1 border-2 border-black rounded "+(p.className||'')} />;

    const MoneyInput = ({label,value,onChange})=>(
      <div><Label>{label}</Label>
        <div className="flex items-center bg-white border-2 border-black rounded px-2 py-2">
          <span className="mr-1">$</span>
          <Text type="text" inputMode="decimal" value={value||''} onChange={e=>onChange(onlyNum(e.target.value))} style={{textAlign:'right'}}/>
        </div>
      </div>
    );
    const PercentInput = ({label,value,onChange})=>(
      <div><Label>{label}</Label>
        <div className="flex items-center bg-white border-2 border-black rounded px-2 py-2">
          <Text type="text" inputMode="decimal" value={value||''} onChange={e=>onChange(onlyNum(e.target.value))} style={{textAlign:'right'}}/>
          <span className="ml-2">%</span>
        </div>
      </div>
    );
    const Card = ({label,value})=>(
      <div className="text-center border-2 border-black rounded py-3 bg-white">
        <div className="text-xs font-bold mb-1 uppercase">{label}</div>
        <div className="text-2xl font-bold">{value}</div>
      </div>
    );

    function NamesWithPills({role,count,names,per,onSet}){
      if (num(count)<=0) return null;
      const meta = {
        vet:{icon:'ðŸ›¡ï¸',title:'VETS â€” Enter Vet Names',ph:'Vet Name #'},
        rep:{icon:'ðŸ“£',title:'REPS â€” Enter Rep Names',ph:'Rep Name #'},
        ra :{icon:'ðŸš—',title:'RIDE-ALONGS â€” Enter Ride-Along Names',ph:'Ride-Along Name #'},
      }[role];
      const colorBar = role==='vet'?'bg-emerald-500':role==='rep'?'bg-violet-300':'bg-red-400';
      const pillCls  = role==='ra'?'pill ra':'pill';
      return (
        <div>
          <div className={"role-title "+(role==='vet'?'text-emerald-900':role==='rep'?'text-violet-900':'text-red-900')}>
            <span>{meta.icon}</span><span>{meta.title}</span>
          </div>
          <div className={"h-1.5 my-2 rounded-full "+colorBar}></div>
          {Array.from({length:num(count)}).map((_,i)=>(
            <div className={pillCls} key={i}>
              <input
                type="text"
                value={(names&&names[i])||''}
                placeholder={meta.ph+(i+1)}
                onChange={e=>onSet(i,e.target.value)}
                className="flex-1 px-2 py-1 border-0 outline-none"
              />
              <div className="amt">{fmt(per)}</div>
            </div>
          ))}
        </div>
      );
    }

    function CalcCard({row,index,rows,setRows,onPrint}){
      const c = useMemo(()=>compute(row), [row]);
      const upd=(k,v)=>{
        setRows(a=>{
          const x=[...a], r={...x[index]};
          if (k==='contractAmount'){
            r.contractAmount=onlyNum(v);
            if (!r.houseFeePercent){ r.houseFeePercent=String(defaultHousePct(r.contractAmount)); }
          } else if (k==='houseFeePercent'){
            r.houseFeePercent=onlyNum(v);
          } else if (k==='numVets'){
            r.numVets=onlyInt(v); r.vetNames=fit(r.vetNames,r.numVets);
          } else if (k==='numReps'){
            r.numReps=onlyInt(v); r.repNames=fit(r.repNames,r.numReps);
          } else if (k==='numRideAlongs'){
            r.numRideAlongs=onlyInt(v); r.rideAlongNames=fit(r.rideAlongNames,r.numRideAlongs);
          } else { r[k]=v; }
          x[index]=r; return x;
        });
      };
      const setName=(kind,i,val)=>{
        setRows(a=>{
          const x=[...a], r={...x[index]};
          const field = kind==='vet'?'vetNames':kind==='rep'?'repNames':'rideAlongNames';
          r[field]=fit(r[field], kind==='vet'?r.numVets:kind==='rep'?r.numReps:r.numRideAlongs);
          r[field][i]=val;
          x[index]=r; return x;
        });
      };

      return (
        <div className="bg-white rounded-lg border-4 border-gray-300 mb-6">
          <div className="bg-blue-300 py-2 px-3 border-b-2 border-black flex items-center justify-between rounded-t">
            <div className="text-sm font-bold uppercase">CALCULATOR #{index+1}</div>
            <button className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded"
                    onClick={()=>onPrint(index)}>Print</button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 border-b-2 border-black">
            <div>
              <Label>Customer Name</Label>
              <Text type="text" value={row.customerName||''} onChange={e=>upd('customerName', e.target.value)}/>
            </div>
            <div>
              <Label>Job Number</Label>
              <Text type="text" value={row.jobNumber||''} onChange={e=>upd('jobNumber', e.target.value)}/>
            </div>
          </div>

          <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <MoneyInput label="Contract Amount" value={row.contractAmount} onChange={v=>upd('contractAmount',v)}/>
                <MoneyInput label="Cash/Check" value={row.cashCheck} onChange={v=>upd('cashCheck',v)}/>
                <MoneyInput label="Labor & Material" value={row.laborMaterial} onChange={v=>upd('laborMaterial',v)}/>
              </div>
              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <MoneyInput label="Finance Amount" value={row.financeAmount} onChange={v=>upd('financeAmount',v)}/>
                  <PercentInput label="Dealer Fee (%)" value={row.dealerFee} onChange={v=>upd('dealerFee',v)}/>
                  <div className="text-center text-sm font-bold text-green-700 mt-1">{fmt(c.dealerFeeAmt)}</div>
                </div>
                <div>
                  <MoneyInput label="Credit Card" value={row.creditCard} onChange={v=>upd('creditCard',v)}/>
                  <PercentInput label="CC Fee (%)" value={row.creditCardFee} onChange={v=>upd('creditCardFee',v)}/>
                  <div className="text-center text-sm font-bold text-green-700 mt-1">{fmt(c.ccFeeAmt)}</div>
                </div>
              </div>
            </div>

            <div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <PercentInput label="House Fee (%)" value={row.houseFeePercent} onChange={v=>upd('houseFeePercent',v)}/>
                  <div className="text-center text-sm mt-2">House: {fmt(c.houseFee)}</div>
                  <div className="text-[11px] text-center text-gray-600 mt-1">Auto: 10% â‰¤ $20k; 9% â‰¤ $30k; 8% &gt; $30k</div>
                </div>
                <div>
                  <MoneyInput label="Ride Along Fee" value={row.rideAlong} onChange={v=>upd('rideAlong',v)}/>
                  <div className="text-center text-sm mt-2">
                    Per Person Split: {
                      fmt((num(row.rideAlong)/(num(row.numVets)+num(row.numReps) || 1)))
                    }
                  </div>
                </div>
                <MoneyInput label="Ride Along Bonus" value={row.rideAlongBonus} onChange={v=>upd('rideAlongBonus',v)}/>
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <Card label="Total After Fees" value={fmt(c.afterFees)}/>
                <Card label="Vets %" value={`${c.vetPct}%`}/>
                <Card label="Reps %" value={`${c.repPct}%`}/>
              </div>
            </div>
          </div>

          <div className="px-4 pb-4 grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
              <Label>Vets on Contract</Label>
              <Text type="text" inputMode="numeric" value={row.numVets||''}
                    onChange={e=>upd('numVets', e.target.value)} placeholder="How many VETS?"/>
              {num(row.numVets)>0 && <div className="mt-2 text-xs text-gray-700">Creates {row.numVets} Vet name field(s) below.</div>}
              {num(row.numVets)>0 && <div className="mt-1 text-sm font-bold text-center">Per Vet: {fmt(compute(row).perVet)}</div>}
              <NamesWithPills role="vet" count={row.numVets}
                names={fit(row.vetNames,row.numVets)} per={compute(row).perVet}
                onSet={(i,v)=>{ /* set single name */ 
                  const arr=[...rows]; const r={...arr[index]};
                  r.vetNames=fit(r.vetNames,r.numVets); r.vetNames[i]=v; arr[index]=r; setRows(arr);
                }}/>
            </div>

            <div>
              <Label>Reps on Contract</Label>
              <Text type="text" inputMode="numeric" value={row.numReps||''}
                    onChange={e=>upd('numReps', e.target.value)} placeholder="How many REPS?"/>
              {num(row.numReps)>0 && <div className="mt-2 text-xs text-gray-700">Creates {row.numReps} Rep name field(s) below.</div>}
              {num(row.numReps)>0 && <div className="mt-1 text-sm font-bold text-center">Per Rep: {fmt(compute(row).perRep)}</div>}
              <NamesWithPills role="rep" count={row.numReps}
                names={fit(row.repNames,row.numReps)} per={compute(row).perRep}
                onSet={(i,v)=>{ const arr=[...rows]; const r={...arr[index]};
                  r.repNames=fit(r.repNames,r.numReps); r.repNames[i]=v; arr[index]=r; setRows(arr); }}/>
            </div>

            <div>
              <Label>Ride-Alongs</Label>
              <Text type="text" inputMode="numeric" value={row.numRideAlongs||''}
                    onChange={e=>upd('numRideAlongs', e.target.value)} placeholder="How many RIDE-ALONGS?"/>
              {num(row.numRideAlongs)>0 && <div className="mt-2 text-xs text-gray-700">Creates {row.numRideAlongs} Ride-Along name field(s) below.</div>}
              {num(row.numRideAlongs)>0 && <div className="mt-1 text-sm font-bold text-center">Per RA: {fmt(compute(row).perRA)}</div>}
              <NamesWithPills role="ra" count={row.numRideAlongs}
                names={fit(row.rideAlongNames,row.numRideAlongs)} per={compute(row).perRA}
                onSet={(i,v)=>{ const arr=[...rows]; const r={...arr[index]};
                  r.rideAlongNames=fit(r.rideAlongNames,r.numRideAlongs); r.rideAlongNames[i]=v; arr[index]=r; setRows(arr); }}/>
            </div>
          </div>
        </div>
      );
    }

    function App(){
      const blank=()=>({
        id:Date.now()+Math.random(),
        customerName:'',jobNumber:'',
        contractAmount:'',cashCheck:'',
        financeAmount:'',dealerFee:'',
        creditCard:'',creditCardFee:'',
        houseFeePercent:'', // auto if empty
        laborMaterial:'',rideAlong:'',rideAlongBonus:'',
        numVets:'',numReps:'',numRideAlongs:'',
        vetNames:[],repNames:[],rideAlongNames:[]
      });

      const [rows,setRows]=useState([blank()]);

      const handlePrintOne = (i)=> openPrint(singlePrintHTML(rows[i], i), 'Calculator '+(i+1));
      const handlePrintReport = ()=> openPrint(reportPrintHTML(rows), 'Payout Report');

      return (
        <div className="max-w-6xl mx-auto p-4">
          <div className="bg-white rounded-lg shadow-lg p-4 mb-4 border-4 border-blue-500">
            <div className="flex items-center justify-between flex-wrap gap-3">
              <h1 className="text-xl font-bold text-blue-800">ALTA CAL PROFIT SHARE</h1>
              <div className="flex gap-2">
                <button className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                        onClick={handlePrintReport}>Print Report</button>
                <button className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
                        onClick={()=>setRows(r=>[...r, blank()])}>Add File</button>
              </div>
            </div>
          </div>

          {rows.map((row,i)=>(
            <CalcCard key={row.id} row={row} index={i} rows={rows} setRows={setRows} onPrint={handlePrintOne}/>
          ))}
        </div>
      );
    }

    try{
      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    }catch(e){ showErr(e.message||String(e)); }
  </script>
</body>
</html>
