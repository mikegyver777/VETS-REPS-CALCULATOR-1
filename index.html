<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ALTA CAL PROFIT SHARE</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React UMD + Babel (with presets so JSX compiles) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @media print {
      @page { size: legal; margin: .25in; }
      .no-print { display:none !important; }
      .print-block { font-size: 10px; }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    /* ================= Helpers (global) ================= */
    const fmt = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format((+n)||0);
    const num = s => {
      if (s===null||s===undefined||s==='') return 0;
      const x = parseFloat(String(s).replace(/[,$]/g,''));
      return Number.isFinite(x) ? x : 0;
    };
    const pctFee = (amount, feePct) => (num(amount) * (num(feePct)/100));
    const onlyNum = s => (s||'').replace(/[^0-9.]/g,'');
    const onlyInt = s => (s||'').replace(/[^0-9]/g,'');

    // Make array length == count (fill with "")
    const fit = (arr, count) => {
      const c = Math.max(0, parseInt(count||0,10)||0);
      const base = Array.isArray(arr) ? [...arr] : [];
      if (base.length > c) return base.slice(0,c);
      while (base.length < c) base.push('');
      return base;
    };

    // Core calculation used by UI + print
    function calcOne(d){
      const contract     = num(d.contractAmount);
      const housePct     = num(d.houseFeePercent);
      const houseFee     = (contract * housePct)/100;

      const dealerFeeAmt = pctFee(d.financeAmount, d.dealerFee);
      const ccFeeAmt     = pctFee(d.creditCard, d.creditCardFee);

      const afterHouse   = contract - houseFee;
      const afterFees    = afterHouse - num(d.laborMaterial) - dealerFeeAmt;   // your “totalAfterFees”
      const marginPct    = afterHouse>0 ? (afterFees/afterHouse)*100 : 0;

      // tier schedule
      let vetRate=25, repRate=20;
      if (marginPct >= 50) { vetRate=55; repRate=40; }
      else if (marginPct >= 40) { vetRate=45; repRate=30; }
      else if (marginPct >= 33) { vetRate=35; repRate=25; }

      const vets = num(d.numVets), reps = num(d.numReps);
      const people = vets + reps;

      const vetPool = afterFees * (vetRate/100);
      const repPool = afterFees * (repRate/100);
      const perVet  = people>0 ? vetPool/people : 0;
      const perRep  = people>0 ? repPool/people : 0;

      const rideAlongFee     = num(d.rideAlong);
      const rideAlongBonus   = num(d.rideAlongBonus);
      const rideAlongTotal   = rideAlongFee + rideAlongBonus;
      const rideAlongPer     = (people>0) ? rideAlongFee/people : 0; // fee split across vets+reps
      const ccPer            = (people>0) ? ccFeeAmt/people : 0;

      const netPerVet = perVet - rideAlongPer - ccPer;
      const netPerRep = perRep - rideAlongPer - ccPer;

      const totalVets = netPerVet * vets;
      const totalReps = netPerRep * reps;

      const rasCount  = num(d.numRideAlongs);
      const perRA     = rasCount>0 ? (rideAlongTotal/rasCount) : 0;

      return {
        houseFee, dealerFeeAmt, ccFeeAmt,
        afterFees, marginPct, vetRate, repRate,
        perVet: netPerVet, perRep: netPerRep,
        totalVets, totalReps,
        rideAlongTotal, perRA
      };
    }

    /* ================= Simple Icons ================= */
    const Icon = ({children,size=20}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none"
           stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        {children}
      </svg>
    );
    const Printer = ({size=20}) => (
      <Icon size={size}>
        <polyline points="6 9 6 2 18 2 18 9"></polyline>
        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
        <rect x="6" y="14" width="12" height="8"></rect>
      </Icon>
    );
    const Plus = ({size=20}) => (
      <Icon size={size}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>
    );

    /* ================= App ================= */
    function App(){
      const blank = () => ({
        id: Date.now(),
        customerName:'', jobNumber:'',
        contractAmount:'', cashCheck:'',
        financeAmount:'', dealerFee:'',
        creditCard:'', creditCardFee:'',
        houseFeePercent:'', laborMaterial:'',
        rideAlong:'', rideAlongBonus:'',
        numVets:'', numReps:'', numRideAlongs:'',
        vetNames:[], repNames:[], rideAlongNames:[]
      });

      const [rows, setRows] = React.useState([ blank() ]);
      const [showPrintAll, setShowPrintAll] = React.useState(false);
      const [printIndex, setPrintIndex] = React.useState(null);

      const upd = (idx, key, val) => {
        setRows(r => {
          const a = [...r];
          const row = {...a[idx]};
          if (key==='numVets')       { row.numVets = onlyInt(val);       row.vetNames       = fit(row.vetNames, row.numVets); }
          else if (key==='numReps')  { row.numReps = onlyInt(val);       row.repNames       = fit(row.repNames, row.numReps); }
          else if (key==='numRideAlongs') { row.numRideAlongs = onlyInt(val); row.rideAlongNames = fit(row.rideAlongNames, row.numRideAlongs); }
          else row[key]=val;
          a[idx]=row; return a;
        });
      };

      const updName = (idx, kind, i, val) => {
        setRows(r=>{
          const a=[...r], row={...a[idx]};
          const key = kind+'Names';
          const count = kind==='vet' ? row.numVets : kind==='rep' ? row.numReps : row.numRideAlongs;
          row[key] = fit(row[key], count);
          row[key][i] = val;
          a[idx]=row; return a;
        });
      };

      return (
        <div className="max-w-6xl mx-auto p-4">
          <div className="bg-white border-4 border-blue-500 rounded-lg p-4 mb-4">
            <div className="flex items-center justify-between">
              <h1 className="text-2xl font-bold text-blue-800">ALTA CAL PROFIT SHARE</h1>
              <div className="flex gap-2">
                <button className="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2"
                        onClick={()=>setShowPrintAll(true)}>
                  <Printer/> Print Report
                </button>
                <button className="bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2"
                        onClick={()=>setRows(r=>[...r, blank()])}>
                  <Plus/> Add File
                </button>
              </div>
            </div>
          </div>

          {rows.map((row, idx)=>{
            const c = calcOne(row);
            return (
              <div key={row.id} className="bg-white border-4 border-gray-300 rounded-lg mb-6">
                {/* header */}
                <div className="bg-blue-300 border-b-2 border-black px-4 py-2 flex justify-between items-center">
                  <strong>CALCULATOR #{idx+1}</strong>
                  <button className="bg-blue-600 text-white px-3 py-1 rounded flex items-center gap-1"
                          onClick={()=>setPrintIndex(idx)}>
                    <Printer/> Print
                  </button>
                </div>

                {/* top row */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 border-b-2 border-black">
                  <Labeled label="CUSTOMER NAME" value={row.customerName} onChange={v=>upd(idx,'customerName',v)}/>
                  <Labeled label="JOB NUMBER" value={row.jobNumber} onChange={v=>upd(idx,'jobNumber',v)}/>
                </div>

                {/* money inputs */}
                <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                  <Money   label="CONTRACT AMOUNT" value={row.contractAmount} onChange={v=>upd(idx,'contractAmount',onlyNum(v))}/>
                  <Money   label="CASH/CHECK"      value={row.cashCheck}      onChange={v=>upd(idx,'cashCheck',onlyNum(v))}/>
                  <Money   label="LABOR & MATERIAL" value={row.laborMaterial}  onChange={v=>upd(idx,'laborMaterial',onlyNum(v))}/>
                </div>

                <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="border-2 rounded p-3">
                    <Money label="FINANCE AMOUNT" value={row.financeAmount} onChange={v=>upd(idx,'financeAmount',onlyNum(v))}/>
                    <Pct   label="DEALER FEE (%)" value={row.dealerFee}     onChange={v=>upd(idx,'dealerFee',onlyNum(v))}/>
                    <div className="text-sm text-center font-bold mt-1">{fmt(c.dealerFeeAmt)}</div>
                  </div>
                  <div className="border-2 rounded p-3">
                    <Money label="CREDIT CARD" value={row.creditCard} onChange={v=>upd(idx,'creditCard',onlyNum(v))}/>
                    <Pct   label="CC FEE (%)"  value={row.creditCardFee} onChange={v=>upd(idx,'creditCardFee',onlyNum(v))}/>
                    <div className="text-sm text-center font-bold mt-1">{fmt(c.ccFeeAmt)}</div>
                  </div>
                </div>

                <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="border-2 rounded p-3">
                    <Pct label="HOUSE FEE (%)" value={row.houseFeePercent} onChange={v=>upd(idx,'houseFeePercent',onlyNum(v))}/>
                    <div className="text-center text-lg font-bold mt-1">House: {fmt(c.houseFee)}</div>
                  </div>
                  <div className="border-2 rounded p-3">
                    <Money label="RIDE ALONG FEE" value={row.rideAlong} onChange={v=>upd(idx,'rideAlong',onlyNum(v))}/>
                    <div className="text-center text-sm font-bold mt-1">Per Person Split: {fmt((num(row.rideAlong)/(num(row.numVets)+num(row.numReps)||1)))}</div>
                  </div>
                  <Money label="RIDE ALONG BONUS" value={row.rideAlongBonus} onChange={v=>upd(idx,'rideAlongBonus',onlyNum(v))}/>
                </div>

                <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                  <Stat title="TOTAL AFTER FEES" value={fmt(c.afterFees)}/>
                  <Stat title="VETS %" value={`${c.vetRate}%`}/>
                  <Stat title="REPS %" value={`${c.repRate}%`}/>
                </div>

                {/* === COUNTS + NAMES WITH AMOUNTS (the key part you asked) === */}
                <div className="p-4 space-y-6 border-t-2 border-black">
                  {/* VETS */}
                  <div className="space-y-3">
                    <Count label="VETS ON CONTRACT" value={row.numVets} onChange={v=>upd(idx,'numVets',v)}/>
                    {num(row.numVets)>0 && (
                      <ListWithAmounts
                        label="VET"
                        names={fit(row.vetNames,row.numVets)}
                        perAmount={c.perVet}
                        color="green"
                        onNameChange={(i,val)=>updName(idx,'vet',i,val)}
                      />
                    )}
                  </div>

                  {/* REPS */}
                  <div className="space-y-3">
                    <Count label="REPS ON CONTRACT" value={row.numReps} onChange={v=>upd(idx,'numReps',v)}/>
                    {num(row.numReps)>0 && (
                      <ListWithAmounts
                        label="REP"
                        names={fit(row.repNames,row.numReps)}
                        perAmount={c.perRep}
                        color="purple"
                        onNameChange={(i,val)=>updName(idx,'rep',i,val)}
                      />
                    )}
                  </div>

                  {/* RIDE ALONGS */}
                  <div className="space-y-3">
                    <Count label="RIDE ALONGS" value={row.numRideAlongs} onChange={v=>upd(idx,'numRideAlongs',v)}/>
                    {num(row.numRideAlongs)>0 && (
                      <ListWithAmounts
                        label="RIDE ALONG"
                        names={fit(row.rideAlongNames,row.numRideAlongs)}
                        perAmount={c.perRA}
                        color="red"
                        onNameChange={(i,val)=>updName(idx,'rideAlong',i,val)}
                      />
                    )}
                  </div>
                </div>
              </div>
            );
          })}

          {/* PRINT ALL */}
          {showPrintAll && (
            <PrintAll rows={rows} onClose={()=>setShowPrintAll(false)}/>
          )}

          {/* PRINT SINGLE */}
          {printIndex!==null && (
            <PrintOne row={rows[printIndex]} index={printIndex} onClose={()=>setPrintIndex(null)}/>
          )}
        </div>
      );
    }

    /* ============== Small UI bits ============== */
    const Labeled = ({label,value,onChange}) => (
      <div>
        <label className="text-xs font-bold block mb-1">{label}</label>
        <input className="w-full border-2 rounded px-2 py-2" value={value||''} onChange={e=>onChange(e.target.value)}/>
      </div>
    );
    const Money = ({label,value,onChange}) => (
      <div>
        <label className="text-xs font-bold block mb-1">{label}</label>
        <div className="flex items-center border-2 rounded px-2 py-2"><span className="mr-1">$</span>
          <input className="w-full text-right outline-none" value={value||''} onChange={e=>onChange(e.target.value)} inputMode="decimal"/>
        </div>
      </div>
    );
    const Pct = ({label,value,onChange}) => (
      <div>
        <label className="text-xs font-bold block mb-1">{label}</label>
        <div className="flex items-center border-2 rounded px-2 py-2">
          <input className="w-full text-right outline-none" value={value||''} onChange={e=>onChange(e.target.value)} inputMode="decimal"/>
          <span className="ml-1">%</span>
        </div>
      </div>
    );
    const Count = ({label,value,onChange}) => (
      <div>
        <label className="text-xs font-bold block mb-1">{label}</label>
        <input className="w-32 text-center text-lg border-2 rounded px-2 py-2" value={value||''} onChange={e=>onChange(onlyInt(e.target.value))} inputMode="numeric"/>
      </div>
    );
    const Stat = ({title,value}) => (
      <div className="border-2 rounded p-3 text-center">
        <div className="text-xs font-bold mb-1">{title}</div>
        <div className="text-xl font-bold">{value}</div>
      </div>
    );

    // List of name fields with amount on the right (e.g., "John Doe   $12,000")
    function ListWithAmounts({label, names, perAmount, color='gray', onNameChange}){
      const colorMap = {
        green:  'border-green-600 text-green-700',
        purple: 'border-purple-600 text-purple-700',
        red:    'border-red-600 text-red-700',
        gray:   'border-gray-600 text-gray-700'
      };
      const c = colorMap[color] || colorMap.gray;
      return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          {names.map((n,i)=>(
            <div key={i} className={`flex items-center justify-between border rounded px-3 py-2 bg-white ${c}`}>
              <div className="flex-1 mr-2">
                <input className="w-full outline-none"
                       placeholder={`${label} ${i+1} Name`}
                       value={n||''}
                       onChange={e=>onNameChange(i,e.target.value)}/>
              </div>
              <div className="font-extrabold">{fmt(perAmount)}</div>
            </div>
          ))}
        </div>
      );
    }

    /* ============== Print Views ============== */
    function PrintAll({rows, onClose}){
      return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-4 w-full max-w-5xl max-h-[90vh] overflow-auto print-block">
            <h2 className="text-xl font-bold text-center mb-3">ALTA CAL PROFIT SHARE — REPORT</h2>
            {rows.map((row,idx)=>{
              const c = calcOne(row);
              const vets = fit(row.vetNames, row.numVets);
              const reps = fit(row.repNames, row.numReps);
              const ras  = fit(row.rideAlongNames, row.numRideAlongs);
              return (
                <div key={idx} className="mb-4 border-b pb-3">
                  <div className="font-bold mb-1">#{idx+1} — {row.customerName || 'N/A'} (Job: {row.jobNumber || 'N/A'})</div>

                  {num(row.numVets)>0 && (
                    <div className="ml-2 mb-1">
                      <div className="font-bold">Vets:</div>
                      {vets.map((n,i)=>
                        <div key={i} className="flex justify-between">
                          <span>{n || `Vet ${i+1}`}</span><span>{fmt(c.perVet)}</span>
                        </div>
                      )}
                    </div>
                  )}

                  {num(row.numReps)>0 && (
                    <div className="ml-2 mb-1">
                      <div className="font-bold">Reps:</div>
                      {reps.map((n,i)=>
                        <div key={i} className="flex justify-between">
                          <span>{n || `Rep ${i+1}`}</span><span>{fmt(c.perRep)}</span>
                        </div>
                      )}
                    </div>
                  )}

                  {num(row.numRideAlongs)>0 && (
                    <div className="ml-2">
                      <div className="font-bold">Ride Alongs:</div>
                      {ras.map((n,i)=>
                        <div key={i} className="flex justify-between">
                          <span>{n || `Ride Along ${i+1}`}</span><span>{fmt(c.perRA)}</span>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
            <div className="no-print flex justify-center gap-2 mt-2">
              <button className="bg-blue-600 text-white px-4 py-2 rounded" onClick={()=>window.print()}>PRINT</button>
              <button className="bg-gray-600 text-white px-4 py-2 rounded" onClick={onClose}>CLOSE</button>
            </div>
          </div>
        </div>
      );
    }

    function PrintOne({row, index, onClose}){
      const c   = calcOne(row);
      const vets= fit(row.vetNames, row.numVets);
      const reps= fit(row.repNames, row.numReps);
      const ras = fit(row.rideAlongNames, row.numRideAlongs);
      return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-4 w-full max-w-3xl max-h-[90vh] overflow-auto print-block">
            <h2 className="text-xl font-bold text-center mb-3">ALTA CAL — CALCULATOR #{index+1}</h2>
            <div className="mb-2"><strong>Customer:</strong> {row.customerName || 'N/A'} &nbsp; | &nbsp; <strong>Job#:</strong> {row.jobNumber || 'N/A'}</div>
            <div className="mb-3"><strong>Total After Fees:</strong> {fmt(c.afterFees)} &nbsp; | &nbsp; <strong>Vet %:</strong> {c.vetRate}% &nbsp; | &nbsp; <strong>Rep %:</strong> {c.repRate}%</div>

            {num(row.numVets)>0 && (
              <div className="mb-2">
                <div className="font-bold">Vets</div>
                {vets.map((n,i)=>(
                  <div key={i} className="flex justify-between"><span>{n || `Vet ${i+1}`}</span><span>{fmt(c.perVet)}</span></div>
                ))}
              </div>
            )}

            {num(row.numReps)>0 && (
              <div className="mb-2">
                <div className="font-bold">Reps</div>
                {reps.map((n,i)=>(
                  <div key={i} className="flex justify-between"><span>{n || `Rep ${i+1}`}</span><span>{fmt(c.perRep)}</span></div>
                ))}
              </div>
            )}

            {num(row.numRideAlongs)>0 && (
              <div className="mb-2">
                <div className="font-bold">Ride Alongs</div>
                {ras.map((n,i)=>(
                  <div key={i} className="flex justify-between"><span>{n || `Ride Along ${i+1}`}</span><span>{fmt(c.perRA)}</span></div>
                ))}
              </div>
            )}

            <div className="no-print flex justify-center gap-2 mt-2">
              <button className="bg-blue-600 text-white px-4 py-2 rounded" onClick={()=>window.print()}>PRINT</button>
              <button className="bg-gray-600 text-white px-4 py-2 rounded" onClick={onClose}>CLOSE</button>
            </div>
          </div>
        </div>
      );
    }

    /* Mount */
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
