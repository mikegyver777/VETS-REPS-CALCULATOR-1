<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ALTA CAL PROFIT SHARE</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (UMD, no Babel) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <style>
    html { -webkit-text-size-adjust: 100%; }
    * { -webkit-tap-highlight-color: transparent; }
    input, button { font-size: 16px; }

    .pill{border-width:2px;border-radius:10px;padding:8px 12px;display:flex;justify-content:space-between;gap:12px;background:#fff}
    .pill-purple{border-color:#7c3aed}.pill-purple .amt{color:#7c3aed;font-weight:800}
    .pill-red{border-color:#ef4444}.pill-red .amt{color:#ef4444;font-weight:800}

    @media print{
      @page { size: legal; margin: 0.5in; }
      body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
      .no-print{display:none!important}
      .print-page{page-break-after:always}
      .print h1{font-size:22px;margin:0 0 10px;text-align:center;border-bottom:3px solid #000;padding-bottom:6px}
      .print h2{font-size:16px;margin:10px 0 6px}
      .print table{width:100%;border-collapse:collapse}
      .print th,.print td{border:1px solid #000;padding:6px 8px;font-size:14px}
      .right{text-align:right}
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script>
    // ---------- React helpers ----------
    const { useState, useMemo } = React;
    const h = React.createElement;

    // ---------- safe helpers ----------
    const num = v => {
      const x = parseFloat(String(v ?? '').replace(/[,$]/g,''));
      return Number.isFinite(x) ? x : 0;
    };
    const onlyNum = s => String(s||'').replace(/[^0-9.]/g,'');
    const onlyInt = s => String(s||'').replace(/[^0-9]/g,'');
    const fmt = v => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Number(v)||0);

    const defaultHousePct = (contractAmount) => {
      const a = num(contractAmount);
      if (a <= 20000) return 10;
      if (a <= 30000) return 9;
      return 8;
    };

    function tierRates(afterFees, afterHouse){
      const margin = afterHouse>0 ? (afterFees/afterHouse)*100 : 0;
      let vet=25, rep=20;
      if (margin>=50){ vet=55; rep=40; }
      else if (margin>=40){ vet=45; rep=30; }
      else if (margin>=33){ vet=35; rep=25; }
      return { vetPct:vet, repPct:rep, margin };
    }

    function compute(row){
      const contract = num(row.contractAmount);
      const housePct = row.houseFeePercent ? num(row.houseFeePercent) : defaultHousePct(contract);
      const houseFee = contract * housePct/100;

      const finance = num(row.financeAmount);
      const dealerPct = num(row.dealerFee);
      const dealerFeeAmt = finance * dealerPct/100;

      const credit = num(row.creditCard);
      const ccPct = num(row.creditCardFee);
      const ccFeeAmt = credit * ccPct/100;

      const labor = num(row.laborMaterial);

      const afterHouse = contract - houseFee;
      const afterFees  = afterHouse - labor - dealerFeeAmt;

      const { vetPct, repPct, margin } = tierRates(afterFees, afterHouse);

      const vets = num(row.numVets), reps = num(row.numReps), people = vets+reps || 0;

      const vetPool = afterFees * vetPct/100;
      const repPool = afterFees * repPct/100;

      const perVetBase = people ? (vetPool/people) : 0;
      const perRepBase = people ? (repPool/people) : 0;

      const rideAlongFee = num(row.rideAlong);
      const rideAlongBonus = num(row.rideAlongBonus);
      const rideAlongTotal = rideAlongFee + rideAlongBonus;

      const rideAlongPerPerson = people ? (rideAlongFee/people) : 0;
      const ccPerPerson = people ? (ccFeeAmt/people) : 0;

      const perVet = perVetBase - rideAlongPerPerson - ccPerPerson;
      const perRep = perRepBase - rideAlongPerPerson - ccPerPerson;

      const perRA  = num(row.numRideAlongs) ? (rideAlongTotal/num(row.numRideAlongs)) : 0;

      return {
        contract, housePct, houseFee, finance, dealerPct, dealerFeeAmt,
        credit, ccPct, ccFeeAmt, labor, afterFees, afterHouse,
        vetPct, repPct, margin, perVet, perRep, perRA, rideAlongTotal
      };
    }

    const fit = (arr, count) => {
      const c = Math.max(0, parseInt(count||0,10)||0);
      const base = Array.isArray(arr) ? [...arr] : [];
      if (base.length > c) return base.slice(0,c);
      while (base.length < c) base.push('');
      return base;
    };

    function openPrint(html,title){
      const w = window.open('', '_blank');
      if(!w){ alert('Pop-up blocked. Allow pop-ups for this site.'); return; }
      w.document.open();
      w.document.write(
        '<!doctype html><html><head><meta charset="utf-8"><title>'+title+
        '</title><style>@page{size:legal;margin:0.5in}body{print-color-adjust:exact;-webkit-print-color-adjust:exact}'+
        '.print-page{page-break-after:always}.print h1{font-size:22px;margin:0 0 10px;text-align:center;border-bottom:3px solid #000;padding-bottom:6px}'+
        '.print h2{font-size:16px;margin:10px 0 6px}.print table{width:100%;border-collapse:collapse}.print th,.print td{border:1px solid #000;padding:6px 8px;font-size:14px}.right{text-align:right}</style></head><body class="print">'+
        html+'</body></html>'
      );
      w.document.close();
      setTimeout(()=>{ w.focus(); w.print(); }, 80);
    }

    function buildSingle(row, idx){
      const c = compute(row);
      const vetNames = fit(row.vetNames, row.numVets);
      const repNames = fit(row.repNames, row.numReps);
      const raNames  = fit(row.rideAlongNames, row.numRideAlongs);

      const vetsBlock = vetNames.length ? (
        '<h2>VETS (Per: '+fmt(c.perVet)+')</h2>'+
        '<table><thead><tr><th>Name</th><th>Payout</th></tr></thead><tbody>'+
        vetNames.map(v=>'<tr><td>'+(String(v||'').trim())+'</td><td class="right">'+fmt(c.perVet)+'</td></tr>').join('')+
        '</tbody></table>'
      ) : '';

      const repsBlock = repNames.length ? (
        '<h2>REPS (Per: '+fmt(c.perRep)+')</h2>'+
        '<table><thead><tr><th>Name</th><th>Payout</th></tr></thead><tbody>'+
        repNames.map(v=>'<tr><td>'+(String(v||'').trim())+'</td><td class="right">'+fmt(c.perRep)+'</td></tr>').join('')+
        '</tbody></table>'
      ) : '';

      const raBlock = raNames.length ? (
        '<h2>RIDE ALONGS (Per: '+fmt(c.perRA)+')</h2>'+
        '<table><thead><tr><th>Name</th><th>Payout</th></tr></thead><tbody>'+
        raNames.map(v=>'<tr><td>'+(String(v||'').trim())+'</td><td class="right">'+fmt(c.perRA)+'</td></tr>').join('')+
        '</tbody></table>'
      ) : '';

      return (
        '<div class="print-page">'+
          '<h1>ALTA CAL — CALCULATOR #'+(idx+1)+'</h1>'+
          '<table style="margin-bottom:8px"><tbody>'+
            '<tr><th>Customer</th><td>'+(String(row.customerName||'').trim()||'N/A')+'</td></tr>'+
            '<tr><th>Job#</th><td>'+(String(row.jobNumber||'').trim()||'N/A')+'</td></tr>'+
          '</tbody></table>'+

          '<h2>CONTRACT & FEE BREAKDOWN</h2>'+
          '<table style="margin-bottom:12px"><tbody>'+
            '<tr><th>Contract</th><td>'+fmt(c.contract)+'</td></tr>'+
            '<tr><th>Finance Amount</th><td>'+fmt(c.finance)+'</td></tr>'+
            '<tr><th>Credit Card</th><td>'+fmt(c.credit)+'</td></tr>'+
            '<tr><th>Labor & Material</th><td>'+fmt(c.labor)+'</td></tr>'+
            '<tr><th>House Fee %</th><td>'+c.housePct+'% (Amt: '+fmt(c.houseFee)+')</td></tr>'+
            '<tr><th>Dealer Fee %</th><td>'+c.dealerPct+'% (Amt: '+fmt(c.dealerFeeAmt)+')</td></tr>'+
            '<tr><th>CC Fee %</th><td>'+c.ccPct+'% (Amt: '+fmt(c.ccFeeAmt)+')</td></tr>'+
            '<tr><th>Total After Fees</th><td>'+fmt(c.afterFees)+'</td></tr>'+
          '</tbody></table>'+

          '<table style="margin-bottom:12px"><thead><tr><th>VETS %</th><th>REPS %</th></tr></thead>'+
          '<tbody><tr><td>'+c.vetPct+'%</td><td>'+c.repPct+'%</td></tr></tbody></table>'+

          vetsBlock + repsBlock + raBlock +
        '</div>'
      );
    }

    function buildReport(rows){
      const fileRows = rows.map((row,i)=>{
        const c = compute(row);
        const v = num(row.numVets), r = num(row.numReps), ra = num(row.numRideAlongs);
        return '<tr>'+
          '<td>'+(i+1)+'</td>'+
          '<td>'+(String(row.customerName||'').trim()||'N/A')+'</td>'+
          '<td>'+(String(row.jobNumber||'').trim()||'N/A')+'</td>'+
          '<td class="right">'+(v||'')+'</td>'+
          '<td class="right">'+(v?fmt(c.perVet):'')+'</td>'+
          '<td class="right">'+(v?fmt(c.perVet*v):'')+'</td>'+
          '<td class="right">'+(r||'')+'</td>'+
          '<td class="right">'+(r?fmt(c.perRep):'')+'</td>'+
          '<td class="right">'+(r?fmt(c.perRep*r):'')+'</td>'+
          '<td class="right">'+(ra||'')+'</td>'+
          '<td class="right">'+(ra?fmt(c.perRA):'')+'</td>'+
          '<td class="right">'+(ra?fmt(c.perRA*ra):'')+'</td>'+
        '</tr>';
      }).join('');

      const totals = {};
      const add = (name, amt) => {
        const key = String(name||'').trim() || '(Unnamed)';
        totals[key] = (totals[key]||0) + (amt||0);
      };
      rows.forEach(row=>{
        const c = compute(row);
        fit(row.vetNames,row.numVets).forEach(nm=>add(nm,c.perVet));
        fit(row.repNames,row.numReps).forEach(nm=>add(nm,c.perRep));
        fit(row.rideAlongNames,row.numRideAlongs).forEach(nm=>add(nm,c.perRA));
      });
      const people = Object.entries(totals).sort((a,b)=>a[0].localeCompare(b[0]));
      const peopleRows = people.map(([nm,amt])=>'<tr><td>'+nm+'</td><td class="right">'+fmt(amt)+'</td></tr>').join('') || '<tr><td colspan="2">(No names)</td></tr>';

      return (
        '<div class="print-page">'+
          '<h1>ALTA CAL PROFIT SHARE — PAYOUT REPORT</h1>'+
          '<table>'+
            '<thead><tr>'+
              '<th>#</th><th>Customer</th><th>Job#</th>'+
              '<th>Vets</th><th>Per Vet</th><th>Total Vets</th>'+
              '<th>Reps</th><th>Per Rep</th><th>Total Reps</th>'+
              '<th>RAs</th><th>Per RA</th><th>Total RA</th>'+
            '</tr></thead>'+
            '<tbody>'+fileRows+'</tbody>'+
          '</table>'+
          '<h2>TOTAL BY PERSON (ALL FILES)</h2>'+
          '<table><thead><tr><th>Person</th><th>Amount</th></tr></thead>'+
            '<tbody>'+peopleRows+'</tbody></table>'+
        '</div>'
      );
    }

    // ---------- UI primitives ----------
    const Label = (t)=>h('label',{className:'text-xs font-bold text-black block mb-1 uppercase tracking-wide'},t);
    const Input = (props)=>h('input', Object.assign({
      className:'w-full px-2 py-1 border-2 border-black rounded focus:outline-none'
    }, props));
    const MoneyInput = ({label,value,onChange}) => h('div',{},[
      Label(label),
      h('div',{className:'flex items-center bg-white border-2 border-black rounded px-2 py-1'},[
        h('span',{className:'mr-1'},'$'),
        Input({type:'text', inputMode:'decimal', value:value||'', onChange:(e)=>onChange(onlyNum(e.target.value)), style:{textAlign:'right'}})
      ])
    ]);
    const PercentInput = ({label,value,onChange}) => h('div',{},[
      Label(label),
      h('div',{className:'flex items-center bg-white border-2 border-black rounded px-2 py-1'},[
        Input({type:'text', inputMode:'decimal', value:value||'', onChange:(e)=>onChange(onlyNum(e.target.value)), style:{textAlign:'right'}}),
        h('span',{className:'ml-2'},'%')
      ])
    ]);
    function NamesWithPills({kind, count, names, per, color, onSet}) {
      if (num(count)<=0) return null;
      return h('div',{},[
        h('div',{className:'text-xs font-bold mb-1 uppercase'}, kind.toUpperCase()),
        ...fit(names,count).map((name,i)=>h('div',{key:i, className:'pill '+(color==='red'?'pill-red':'pill-purple')+' mb-2'},[
          Input({type:'text', value:name||'', onChange:(e)=>onSet(i, e.target.value), className:'flex-1 px-2 py-1 border-0 outline-none'}),
          h('div',{className:'amt'}, fmt(per))
        ]))
      ]);
    }
    function CardTotal({label, value}) {
      return h('div',{className:'text-center border-2 border-black rounded py-3 bg-white'},[
        h('div',{className:'text-xs font-bold mb-1 uppercase'},label),
        h('div',{className:'text-2xl font-bold'}, value)
      ]);
    }

    // ---------- Calculator card ----------
    function CalcCard({row,index,rows,setRows,onPrint}) {
      const c = useMemo(()=>compute(row), [row]);

      const upd = (k,v)=>{
        setRows(a=>{
          const x=[...a], r={...x[index]};
          if (k==='contractAmount') {
            r.contractAmount = onlyNum(v);
            // auto house % when user hasn't set a custom value
            if (!r.houseFeePercent || r.houseFeePercent === String(defaultHousePct(row.contractAmount))) {
              r.houseFeePercent = String(defaultHousePct(r.contractAmount));
            }
          } else if (k==='houseFeePercent') {
            r.houseFeePercent = onlyNum(v);
          } else if (k==='numVets') {
            r.numVets = onlyInt(v); r.vetNames = fit(r.vetNames, r.numVets);
          } else if (k==='numReps') {
            r.numReps = onlyInt(v); r.repNames = fit(r.repNames, r.numReps);
          } else if (k==='numRideAlongs') {
            r.numRideAlongs = onlyInt(v); r.rideAlongNames = fit(r.rideAlongNames, r.numRideAlongs);
          } else {
            r[k]=v;
          }
          x[index]=r; return x;
        });
      };

      const setName = (key,i,val)=>{
        setRows(a=>{
          const x=[...a], r={...x[index]};
          const map = {vet:'vetNames', rep:'repNames', ra:'rideAlongNames'};
          const field = map[key];
          r[field] = fit(r[field], key==='vet'?r.numVets:key==='rep'?r.numReps:r.numRideAlongs);
          r[field][i] = val;
          x[index]=r; return x;
        });
      };

      return h('div',{className:'bg-white rounded-lg border-4 border-gray-300 mb-6'},[
        h('div',{className:'bg-blue-300 py-2 px-3 border-b-2 border-black flex items-center justify-between rounded-t'},[
          h('div',{className:'text-sm font-bold uppercase'} ,`CALCULATOR #${index+1}`),
          h('button',{className:'bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded', onClick:()=>onPrint(index)},'Print')
        ]),

        h('div',{className:'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 border-b-2 border-black'},[
          h('div',{},[ h('label',{className:'text-xs font-bold block mb-1 uppercase'},'Customer Name'),
            h('input',{type:'text', value:row.customerName||'', onChange:(e)=>upd('customerName', e.target.value),
              className:'w-full px-2 py-1 border-2 border-black rounded'}) ]),
          h('div',{},[ h('label',{className:'text-xs font-bold block mb-1 uppercase'},'Job Number'),
            h('input',{type:'text', value:row.jobNumber||'', onChange:(e)=>upd('jobNumber', e.target.value),
              className:'w-full px-2 py-1 border-2 border-black rounded'}) ])
        ]),

        h('div',{className:'p-4 grid grid-cols-1 md:grid-cols-2 gap-4'},[
          h('div',{},[
            h('div',{className:'grid grid-cols-1 md:grid-cols-3 gap-4'},[
              MoneyInput({label:'Contract Amount', value:row.contractAmount, onChange:(v)=>upd('contractAmount', v)}),
              MoneyInput({label:'Cash/Check', value:row.cashCheck, onChange:(v)=>upd('cashCheck', v)}),
              MoneyInput({label:'Labor & Material', value:row.laborMaterial, onChange:(v)=>upd('laborMaterial', v)}),
            ]),
            h('div',{className:'mt-4 grid grid-cols-1 md:grid-cols-2 gap-4'},[
              h('div',{},[
                MoneyInput({label:'Finance Amount', value:row.financeAmount, onChange:(v)=>upd('financeAmount', v)}),
                PercentInput({label:'Dealer Fee (%)', value:row.dealerFee, onChange:(v)=>upd('dealerFee', v)}),
                h('div',{className:'text-center text-sm font-bold text-green-700 mt-1'}, fmt(c.dealerFeeAmt))
              ]),
              h('div',{},[
                MoneyInput({label:'Credit Card', value:row.creditCard, onChange:(v)=>upd('creditCard', v)}),
                PercentInput({label:'CC Fee (%)', value:row.creditCardFee, onChange:(v)=>upd('creditCardFee', v)}),
                h('div',{className:'text-center text-sm font-bold text-green-700 mt-1'}, fmt(c.ccFeeAmt))
              ])
            ])
          ]),
          h('div',{},[
            h('div',{className:'grid grid-cols-1 md:grid-cols-3 gap-4'},[
              h('div',{},[
                PercentInput({label:'House Fee (%)', value:row.houseFeePercent, onChange:(v)=>upd('houseFeePercent', v)}),
                h('div',{className:'text-center text-sm mt-2'}, 'House: '+fmt(c.houseFee)),
                h('div',{className:'text-[11px] text-center text-gray-600 mt-1'},'Auto: 10% ≤ $20k; 9% ≤ $30k; 8% > $30k')
              ]),
              h('div',{},[
                MoneyInput({label:'Ride Along Fee', value:row.rideAlong, onChange:(v)=>upd('rideAlong', v)}),
                h('div',{className:'text-center text-sm mt-2'}, 'Per Person Split: '+fmt((num(row.rideAlong)/(num(row.numVets)+num(row.numReps) || 1))))
              ]),
              MoneyInput({label:'Ride Along Bonus', value:row.rideAlongBonus, onChange:(v)=>upd('rideAlongBonus', v)})
            ]),
            h('div',{className:'mt-4 grid grid-cols-1 md:grid-cols-3 gap-4'},[
              CardTotal({label:'Total After Fees', value:fmt(c.afterFees)}),
              CardTotal({label:'Vets %', value:c.vetPct+'%'}),
              CardTotal({label:'Reps %', value:c.repPct+'%'})
            ])
          ])
        ]),

        h('div',{className:'px-4 pb-4 grid grid-cols-1 md:grid-cols-3 gap-6'},[
          h('div',{},[
            h('label',{className:'text-xs font-bold block mb-1 uppercase'},'Vets on Contract'),
            h('input',{type:'text', inputMode:'numeric', value:row.numVets||'', onChange:(e)=>upd('numVets', e.target.value),
              className:'w-full px-2 py-1 border-2 border-black rounded'}),
            num(row.numVets)>0 ? h('div',{className:'mt-3 text-sm font-bold text-center'} ,'Per Vet: '+fmt(c.perVet)) : null,
            h(NamesWithPills,{kind:'vet', count:row.numVets, names:fit(row.vetNames,row.numVets), per:c.perVet, color:'purple',
              onSet:(i,val)=>setName('vet',i,val)})
          ]),
          h('div',{},[
            h('label',{className:'text-xs font-bold block mb-1 uppercase'},'Reps on Contract'),
            h('input',{type:'text', inputMode:'numeric', value:row.numReps||'', onChange:(e)=>upd('numReps', e.target.value),
              className:'w-full px-2 py-1 border-2 border-black rounded'}),
            num(row.numReps)>0 ? h('div',{className:'mt-3 text-sm font-bold text-center'} ,'Per Rep: '+fmt(c.perRep)) : null,
            h(NamesWithPills,{kind:'rep', count:row.numReps, names:fit(row.repNames,row.numReps), per:c.perRep, color:'purple',
              onSet:(i,val)=>setName('rep',i,val)})
          ]),
          h('div',{},[
            h('label',{className:'text-xs font-bold block mb-1 uppercase'},'Ride Alongs'),
            h('input',{type:'text', inputMode:'numeric', value:row.numRideAlongs||'', onChange:(e)=>upd('numRideAlongs', e.target.value),
              className:'w-full px-2 py-1 border-2 border-black rounded'}),
            num(row.numRideAlongs)>0 ? h('div',{className:'mt-3 text-sm font-bold text-center'} ,'Per RA: '+fmt(c.perRA)) : null,
            h(NamesWithPills,{kind:'ra', count:row.numRideAlongs, names:fit(row.rideAlongNames,row.numRideAlongs), per:c.perRA, color:'red',
              onSet:(i,val)=>setName('ra',i,val)})
          ])
        ])
      ]);
    }

    function App(){
      const blank = ()=>({
        id: Date.now()+Math.random(),
        customerName:'', jobNumber:'',
        contractAmount:'', cashCheck:'',
        financeAmount:'', dealerFee:'',
        creditCard:'', creditCardFee:'',
        houseFeePercent:'', // auto if left empty
        laborMaterial:'', rideAlong:'', rideAlongBonus:'',
        numVets:'', numReps:'', numRideAlongs:'',
        vetNames:[], repNames:[], rideAlongNames:[]
      });

      const [rows, setRows] = useState([blank()]);

      const printOne   = (i)=> openPrint(buildSingle(rows[i], i), 'Calculator #'+(i+1));
      const printReport= ()=> openPrint(buildReport(rows), 'Payout Report');

      return h('div',{className:'max-w-6xl mx-auto p-4'},[
        h('div',{className:'bg-white rounded-lg shadow-lg p-4 mb-4 border-4 border-blue-500'},[
          h('div',{className:'flex items-center justify-between'},[
            h('h1',{className:'text-xl font-bold text-blue-800'},'ALTA CAL PROFIT SHARE'),
            h('div',{className:'flex gap-2'},[
              h('button',{className:'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded', onClick:printReport},'Print Report'),
              h('button',{className:'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded', onClick:()=>setRows(r=>[...r, blank()])},'Add File')
            ])
          ])
        ]),
        ...rows.map((row,i)=>h(CalcCard,{key:row.id, row, index:i, rows, setRows, onPrint:printOne}))
      ]);
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
