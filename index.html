<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ALTA CAL PROFIT SHARE</title>

  <!-- Mobile Safe -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html { -webkit-text-size-adjust: 100%; }
    input, button { font-size: 16px; }
    * { -webkit-tap-highlight-color: transparent; }

    @media print {
      @page { size: legal; margin: 0.5in; }
      body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
      .no-print { display: none !important; }
      .print-page { font-size: 11px !important; page-break-after: always; }
      .print-page h1 { font-size: 18px !important; margin-bottom: 6px !important; }
      .print-page table { width: 100%; border-collapse: collapse; }
      .print-page th, .print-page td { border: 1px solid black; padding: 4px; }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">

    const { useState } = React;

    const formatCurrency = v => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(v) || 0);
    const parseNum = v => parseFloat(String(v||'').replace(/[,$]/g,'')) || 0;

    function getHouseFee(contractAmount){
      const amt = parseNum(contractAmount);
      if (amt <= 20000) return 10;
      if (amt <= 30000) return 9;
      return 8;
    }

    function calc(data){
      const contract = parseNum(data.contractAmount);
      const housePct = data.houseFeePercent ? parseNum(data.houseFeePercent) : getHouseFee(contract);
      const houseFee = (contract * housePct) / 100;
      const labor = parseNum(data.laborMaterial);
      const dealerFee = (parseNum(data.financeAmount) * parseNum(data.dealerFee || 0)) / 100;
      const afterFees = contract - houseFee - labor - dealerFee;
      const marginPct = (afterFees / (contract - houseFee)) * 100 || 0;

      let vetRate = 25, repRate = 20;
      if (marginPct >= 50){ vetRate=55; repRate=40; }
      else if (marginPct >= 40){ vetRate=45; repRate=30; }
      else if (marginPct >= 33){ vetRate=35; repRate=25; }

      const vets = parseNum(data.numVets);
      const reps = parseNum(data.numReps);
      const people = vets + reps;
      const perVet = (afterFees * vetRate/100) / (people || 1);
      const perRep = (afterFees * repRate/100) / (people || 1);

      return { housePct, houseFee, afterFees, vetRate, repRate, perVet, perRep };
    }

    function App(){
      const [contractAmount, setContractAmount] = useState('');
      const [laborMaterial, setLaborMaterial] = useState('');
      const [financeAmount, setFinanceAmount] = useState('');
      const [dealerFee, setDealerFee] = useState('');
      const [numVets, setNumVets] = useState('');
      const [numReps, setNumReps] = useState('');
      const [vetNames, setVetNames] = useState([]);
      const [repNames, setRepNames] = useState([]);

      const data = { contractAmount, laborMaterial, financeAmount, dealerFee, numVets, numReps };
      const result = calc(data);

      React.useEffect(() => {
        const v = parseInt(numVets || 0);
        setVetNames(Array.from({ length: v }, (_, i) => vetNames[i] || ''));
        const r = parseInt(numReps || 0);
        setRepNames(Array.from({ length: r }, (_, i) => repNames[i] || ''));
      }, [numVets, numReps]);

      const printPage = () => {
        const html = `
          <div class='print-page'>
            <h1>ALTA CAL PROFIT SHARE - CALCULATOR</h1>
            <table>
              <tr><th>Contract Amount</th><td>${formatCurrency(contractAmount)}</td></tr>
              <tr><th>House Fee %</th><td>${result.housePct}%</td></tr>
              <tr><th>House Fee</th><td>${formatCurrency(result.houseFee)}</td></tr>
              <tr><th>Labor & Material</th><td>${formatCurrency(laborMaterial)}</td></tr>
              <tr><th>Dealer Fee %</th><td>${dealerFee || 0}%</td></tr>
              <tr><th>Finance Amount</th><td>${formatCurrency(financeAmount)}</td></tr>
              <tr><th>Total After Fees</th><td>${formatCurrency(result.afterFees)}</td></tr>
              <tr><th>Vet Rate</th><td>${result.vetRate}%</td></tr>
              <tr><th>Rep Rate</th><td>${result.repRate}%</td></tr>
            </table>
            <h2>VETS</h2>
            <table>
              <tr><th>Name</th><th>Payout</th></tr>
              ${vetNames.map(n=>`<tr><td>${n||''}</td><td>${formatCurrency(result.perVet)}</td></tr>`).join('')}
            </table>
            <h2>REPS</h2>
            <table>
              <tr><th>Name</th><th>Payout</th></tr>
              ${repNames.map(n=>`<tr><td>${n||''}</td><td>${formatCurrency(result.perRep)}</td></tr>`).join('')}
            </table>
          </div>`;
        const w = window.open('', '_blank');
        w.document.write(`<html><head><title>Print</title></head><body>${html}</body></html>`);
        w.document.close();
        setTimeout(() => w.print(), 300);
      };

      return (
        <div className="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-lg my-6">
          <h1 className="text-2xl font-bold text-blue-700 mb-4 text-center">ALTA CAL PROFIT SHARE</h1>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block font-bold">Contract Amount</label>
              <input type="number" className="border p-2 w-full" value={contractAmount} onChange={e=>setContractAmount(e.target.value)}/>
            </div>
            <div>
              <label className="block font-bold">Labor & Material</label>
              <input type="number" className="border p-2 w-full" value={laborMaterial} onChange={e=>setLaborMaterial(e.target.value)}/>
            </div>
            <div>
              <label className="block font-bold">Finance Amount</label>
              <input type="number" className="border p-2 w-full" value={financeAmount} onChange={e=>setFinanceAmount(e.target.value)}/>
            </div>
            <div>
              <label className="block font-bold">Dealer Fee %</label>
              <input type="number" className="border p-2 w-full" value={dealerFee} onChange={e=>setDealerFee(e.target.value)}/>
            </div>
          </div>

          <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block font-bold"># of Vets</label>
              <input type="number" className="border p-2 w-full" value={numVets} onChange={e=>setNumVets(e.target.value)}/>
              {vetNames.map((n,i)=>(
                <input key={i} placeholder={`Vet ${i+1} Name`} value={n} className="border p-2 w-full mt-1" onChange={e=>{
                  const arr=[...vetNames]; arr[i]=e.target.value; setVetNames(arr);
                }}/>
              ))}
            </div>
            <div>
              <label className="block font-bold"># of Reps</label>
              <input type="number" className="border p-2 w-full" value={numReps} onChange={e=>setNumReps(e.target.value)}/>
              {repNames.map((n,i)=>(
                <input key={i} placeholder={`Rep ${i+1} Name`} value={n} className="border p-2 w-full mt-1" onChange={e=>{
                  const arr=[...repNames]; arr[i]=e.target.value; setRepNames(arr);
                }}/>
              ))}
            </div>
          </div>

          <div className="mt-6 bg-blue-50 p-4 border rounded-lg">
            <p><strong>House Fee %:</strong> {result.housePct}%</p>
            <p><strong>Total After Fees:</strong> {formatCurrency(result.afterFees)}</p>
            <p><strong>Vet Rate:</strong> {result.vetRate}%</p>
            <p><strong>Rep Rate:</strong> {result.repRate}%</p>
          </div>

          <div className="text-center mt-6">
            <button onClick={printPage} className="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">PRINT</button>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>

  <!-- âœ… Universal Render Fix for iPhone/iPad -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      setTimeout(() => {
        if (window.React && window.ReactDOM && document.getElementById('root').innerHTML.trim() === '') {
          ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
        }
      }, 400);
    });
  </script>
</body>
</html>
