<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ALTA CAL PROFIT SHARE</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html { -webkit-text-size-adjust: 100%; }
    input, button { font-size: 16px; }
    * { -webkit-tap-highlight-color: transparent; }

    @media (max-width: 640px) {
      .header-wrap { flex-wrap: wrap; }
      .header-actions { width: 100%; display: flex; gap: 8px; margin-top: 8px; }
      .header-actions button { flex: 1 1 auto; }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const fmt = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format((+n)||0);
    const num = s => { const x=parseFloat(String(s??'').replace(/[,$]/g,'')); return Number.isFinite(x)?x:0; };
    const onlyNum = s => (s||'').replace(/[^0-9.]/g,'');
    const onlyInt = s => (s||'').replace(/[^0-9]/g,'');
    const fit = (arr, count) => { const c = Math.max(0, parseInt(count||0,10)||0); const base = Array.isArray(arr)?[...arr]:[]; if(base.length>c) return base.slice(0,c); while(base.length<c) base.push(''); return base; };
    const defaultHousePct = a => num(a)<=20000?10:num(a)<30000?9:8;
    const pctFee = (a,p)=>num(a)*(num(p)/100);

    function calcOne(d){
      const housePct=d.houseFeeManual?num(d.houseFeePercent):(d.houseFeePercent?num(d.houseFeePercent):defaultHousePct(d.contractAmount));
      const contract=num(d.contractAmount), houseFee=contract*(housePct/100);
      const dealerFeeAmt=pctFee(d.financeAmount,d.dealerFee);
      const ccFeeAmt=pctFee(d.creditCard,d.creditCardFee);
      const afterHouse=contract-houseFee, afterFees=afterHouse-num(d.laborMaterial)-dealerFeeAmt;
      const marginPct=afterHouse>0?(afterFees/afterHouse)*100:0;
      let vetRate=25,repRate=20;
      if(marginPct>=50){vetRate=55;repRate=40;} else if(marginPct>=40){vetRate=45;repRate=30;} else if(marginPct>=33){vetRate=35;repRate=25;}
      const vets=num(d.numVets),reps=num(d.numReps),people=vets+reps;
      const vetPool=afterFees*(vetRate/100),repPool=afterFees*(repRate/100);
      const perVet=people?vetPool/people:0,perRep=people?repPool/people:0;
      const rideAlongFee=num(d.rideAlong),rideAlongBonus=num(d.rideAlongBonus),rideAlongTotal=rideAlongFee+rideAlongBonus;
      const rideAlongPer=people?rideAlongFee/people:0,ccPer=people?ccFeeAmt/people:0;
      const netPerVet=perVet-rideAlongPer-ccPer,netPerRep=perRep-rideAlongPer-ccPer;
      const totalVets=netPerVet*vets,totalReps=netPerRep*reps,ras=num(d.numRideAlongs),perRA=ras?(rideAlongTotal/ras):0;
      return {contract,housePct,houseFee,finance:num(d.financeAmount),dealerPct:num(d.dealerFee),dealerFeeAmt,credit:num(d.creditCard),ccPct:num(d.creditCardFee),ccFeeAmt,labor:num(d.laborMaterial),afterFees,marginPct,vetRate,repRate,perVet:netPerVet,perRep:netPerRep,totalVets,totalReps,perRA,rideAlongTotal,combined:totalVets+totalReps};
    }

    function openPrintWindow(html,title='Print'){
      const win=window.open('','_blank'); if(!win){alert('Pop-up blocked.');return;}
      win.document.open();
      win.document.write(`<!doctype html><html><head>
        <meta charset="utf-8"><title>${title}</title>
        <style>
          html,body{margin:0;padding:0;}
          @page{size:auto;margin:10mm;}
          body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial,sans-serif;color:#111;}
          h1,h2,h3{margin:0 0 8px;}
          .box{border:2px solid #000;border-radius:6px;padding:10px;margin-bottom:10px;}
          .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
          .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
          .row{display:flex;justify-content:space-between;border-bottom:1px solid #ddd;padding:4px 0;}
          table{width:100%;border-collapse:collapse;}
          th,td{border:1px solid #000;padding:6px 8px;font-size:12px;}
          .right{text-align:right;}
          .muted{color:#555;}
          .page{page-break-after:always;}
          .page:first-of-type{page-break-before:avoid;}
          .chip{border:1px solid #000;border-radius:6px;padding:6px 8px;text-align:center;}
          .total{font-weight:700;}
        </style>
      </head><body>${html.trim()}</body></html>`);
      win.document.close();
      setTimeout(()=>{win.focus();win.print();},50);
    }

    /* -- everything else below remains the same, shortened here for brevity -- */
    /* Your App, calcOne, buildSingleHTML, buildReportHTML, etc. all stay unchanged. */
    /* ... [unchanged rest of your code as before] ... */

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>

  <!-- âœ… FIX FOR IPHONE/IPAD BLANK PAGE -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      setTimeout(() => {
        if (window.React && window.ReactDOM && document.getElementById('root').innerHTML.trim() === '') {
          ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
        }
      }, 400);
    });
  </script>
</body>
</html>
